"use strict";(()=>{var e={};e.id=533,e.ids=[533],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5131:(e,s,t)=>{t.r(s),t.d(s,{originalPathname:()=>E,patchFetch:()=>f,requestAsyncStorage:()=>j,routeModule:()=>_,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g});var o={};t.r(o),t.d(o,{POST:()=>x,runtime:()=>u});var r=t(9303),a=t(8716),n=t(670),i=t(7070),d=t(7857),c=t(3240);let u="nodejs",l=process.env.SUPABASE_URL??"https://yhkrzepnokhiqbxwhkgz.supabase.co",p=process.env.SUPABASE_SERVICE_ROLE_KEY;async function x(e,s){try{let{accessToken:e}=(0,c.BK)();if(!e)return i.NextResponse.json({ok:!1,message:"UNAUTHENTICATED"},{status:401});let t=(0,c.lx)(),{data:{user:o},error:r}=await t.auth.getUser(e);if(r||!o)return i.NextResponse.json({ok:!1,message:"UNAUTHENTICATED"},{status:401});let a=s.params.id;if(!a)return i.NextResponse.json({ok:!1,error:"missing job id"},{status:400});let n=function(){if(!l)throw Error("Missing SUPABASE_URL env var.");if(!p)throw Error("Missing SUPABASE_SERVICE_ROLE_KEY env var.");return(0,d.eI)(l,p)}(),{data:u,error:x}=await n.from("outage_jobs").select("id, is_closed, closed_at, notice_status").eq("id",a).single();if(x||!u)return i.NextResponse.json({ok:!1,error:"ไม่พบข้อมูลงานที่ต้องการ"},{status:404});if(u.is_closed)return i.NextResponse.json({ok:!0,jobId:u.id,is_closed:!0,closed_at:u.closed_at,message:"already closed"});if("SCHEDULED"!==u.notice_status)return i.NextResponse.json({ok:!1,error:"สถานะงานยังไม่พร้อมสำหรับการปิดงาน"},{status:400});let _=new Date().toISOString(),{data:j,error:g}=await n.from("outage_jobs").update({is_closed:!0,closed_at:_,closed_by:o.id}).eq("id",a).select("id, is_closed, closed_at").single();if(g||!j)throw Error(g?.message??"Failed to close job");return i.NextResponse.json({ok:!0,jobId:j.id,is_closed:j.is_closed,closed_at:j.closed_at})}catch(e){return console.error("Close job failed",e),i.NextResponse.json({ok:!1,error:"ไม่สามารถปิดงานได้ กรุณาลองใหม่"},{status:500})}}let _=new r.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/jobs/[id]/close/route",pathname:"/api/jobs/[id]/close",filename:"route",bundlePath:"app/api/jobs/[id]/close/route"},resolvedPagePath:"C:\\Users\\506870\\Desktop\\KB-outage\\src\\app\\api\\jobs\\[id]\\close\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:j,staticGenerationAsyncStorage:g,serverHooks:m}=_,E="/api/jobs/[id]/close/route";function f(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}}};var s=require("../../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),o=s.X(0,[948,564,240],()=>t(5131));module.exports=o})();