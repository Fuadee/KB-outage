(()=>{var e={};e.id=534,e.ids=[534],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},2840:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>o.a,__next_app__:()=>x,originalPathname:()=>c,pages:()=>u,routeModule:()=>m,tree:()=>d}),s(5118),s(2029),s(5866);var r=s(3191),a=s(8716),l=s(7922),o=s.n(l),n=s(5231),i={};for(let e in n)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(i[e]=()=>n[e]);s.d(t,i);let d=["",{children:["job",{children:["[id]",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,5118)),"C:\\Users\\506870\\Desktop\\KB-outage\\src\\app\\job\\[id]\\page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,2029)),"C:\\Users\\506870\\Desktop\\KB-outage\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,5866,23)),"next/dist/client/components/not-found-error"]}],u=["C:\\Users\\506870\\Desktop\\KB-outage\\src\\app\\job\\[id]\\page.tsx"],c="/job/[id]/page",x={require:s,loadChunk:()=>Promise.resolve()},m=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/job/[id]/page",pathname:"/job/[id]",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},519:(e,t,s)=>{Promise.resolve().then(s.t.bind(s,2994,23)),Promise.resolve().then(s.t.bind(s,6114,23)),Promise.resolve().then(s.t.bind(s,9727,23)),Promise.resolve().then(s.t.bind(s,9671,23)),Promise.resolve().then(s.t.bind(s,1868,23)),Promise.resolve().then(s.t.bind(s,4759,23))},6215:()=>{},6899:(e,t,s)=>{Promise.resolve().then(s.bind(s,6163))},6163:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>x});var r=s(326),a=s(7577),l=s(5047),o=s(434),n=s(8168),i=s(9068),d=s(7687),u=s(8927),c=s(1632);function x(){let e=(0,l.useRouter)(),t=(0,l.useParams)(),[s,x]=(0,a.useState)(""),[m,p]=(0,a.useState)(""),[h,b]=(0,a.useState)(""),[f,g]=(0,a.useState)(!0),[y,j]=(0,a.useState)(!1),[v,_]=(0,a.useState)(null),[w,N]=(0,a.useState)(null),[S,k]=(0,a.useState)(!1),[C,E]=(0,a.useState)(!1),[P,q]=(0,a.useState)(!1),[O,D]=(0,a.useState)(null),[U,T]=(0,a.useState)(null),L=async r=>{if(r.preventDefault(),!t.id||w?.is_closed)return;if(_(null),!s||!m.trim()){_("กรุณากรอกวันที่และรหัสอุปกรณ์");return}j(!0);let{error:a}=await (0,u.gK)(t.id,{outage_date:s,equipment_code:m.trim(),note:h.trim()?h.trim():null});if(a){_(a.message),j(!1);return}j(!1),e.push("/")},$=async()=>{if(t.id&&!w?.is_closed){j(!0),_(null);try{let s=await fetch(`/api/jobs/${t.id}/delete`,{method:"DELETE"}),r=await s.json().catch(()=>null);if(!s.ok||!r?.ok||0===r.deletedCount){let e=r?.error??"ลบไม่สำเร็จ (สิทธิไม่อนุญาตหรือไม่พบรายการ)";_(e),T({message:e,tone:"error"}),j(!1);return}e.push("/")}catch(t){let e=t instanceof Error?t.message:"ลบไม่สำเร็จ (สิทธิไม่อนุญาตหรือไม่พบรายการ)";_(e),T({message:e,tone:"error"})}finally{j(!1)}}},B=e=>{N(t=>t?{...t,...e}:t)},K=async()=>{if(!w)return;q(!0),D(null);let{data:t}=await c.O.auth.getSession();if(!t.session){q(!1),E(!1),e.push("/login");return}try{let t=await fetch(`/api/jobs/${w.id}/close`,{method:"POST",headers:{"Content-Type":"application/json"}});if(401===t.status){q(!1),E(!1),e.push("/login");return}let s=await t.json().catch(()=>null);if(!t.ok||!s?.ok)throw Error(s?.error??"ปิดงานไม่สำเร็จ กรุณาลองใหม่");T({message:"✅ ปิดงานเรียบร้อย",tone:"success"}),N(e=>e?{...e,is_closed:!0,closed_at:s.closed_at??new Date().toISOString()}:e),E(!1)}catch(t){let e=t instanceof Error?t.message:"ปิดงานไม่สำเร็จ กรุณาลองใหม่";D(e),T({message:e,tone:"error"})}finally{q(!1)}};if(f)return r.jsx("div",{className:"rounded-2xl border border-slate-200 bg-white px-4 py-8 text-center text-sm text-slate-500 shadow-sm",children:"กำลังโหลดข้อมูล..."});let M=w?.is_closed??!1,A=(w?.notice_status??"NONE")==="SCHEDULED"&&!M;return(0,r.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,r.jsxs)("header",{className:"flex flex-col gap-2",children:[r.jsx("h1",{className:"text-2xl font-semibold",children:M?"รายละเอียดงาน":"แก้ไขงาน"}),r.jsx("p",{className:"text-sm text-slate-500",children:M?"งานนี้ถูกปิดแล้วและไม่สามารถแก้ไขได้":"ปรับปรุงรายละเอียดหรือลบงานนี้ออกจากระบบ"}),U?r.jsx("div",{className:`mt-2 rounded-xl border px-4 py-3 text-sm ${"success"===U.tone?"border-emerald-200 bg-emerald-50 text-emerald-700":"border-red-200 bg-red-50 text-red-700"}`,children:U.message}):null,M?(0,r.jsxs)("div",{className:"mt-2 text-sm text-slate-600",children:["ปิดเมื่อ"," ",r.jsx("span",{className:"font-medium text-slate-800",children:w?.closed_at?new Date(w.closed_at).toLocaleString("th-TH",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-"})]}):null,(0,r.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2",children:[w?.social_status!=="POSTED"||M?null:r.jsx("button",{type:"button",onClick:()=>k(!0),className:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:(w.notice_status??"NONE")==="SCHEDULED"?"กำหนดการแจ้งเรียบร้อยแล้ว (แก้ไขได้)":"แจ้งหนังสือดับไฟ"}),A?r.jsx("button",{type:"button",onClick:()=>{D(null),E(!0)},className:"rounded-xl bg-amber-500 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-amber-400",children:"ปิดงาน"}):null]})]}),(0,r.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm",children:[r.jsx("h2",{className:"text-sm font-semibold text-slate-700",children:"ลิงก์แผนที่"}),(0,r.jsxs)("div",{className:"mt-3 grid gap-3",children:[(0,r.jsxs)("div",{className:"flex flex-col gap-1 text-xs text-slate-500",children:[r.jsx("span",{children:"ลิ้ง Google Map"}),r.jsx(n.Z,{url:w?.map_link??void 0,label:"เปิด Google Map"})]}),(0,r.jsxs)("div",{className:"flex flex-col gap-1 text-xs text-slate-500",children:[r.jsx("span",{children:"ลิ้ง My Map"}),r.jsx(n.Z,{url:w?.mymaps_url??void 0})]})]})]}),(0,r.jsxs)("form",{onSubmit:L,className:"flex flex-col gap-6 rounded-2xl bg-white p-6 shadow-sm",children:[(0,r.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["วันที่ดับไฟ",r.jsx("input",{type:"date",value:s,onChange:e=>x(e.target.value),disabled:M,className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0})]}),(0,r.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["รหัสอุปกรณ์",r.jsx("input",{type:"text",value:m,onChange:e=>p(e.target.value),disabled:M,className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0})]}),(0,r.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["หมายเหตุเพิ่มเติม",r.jsx("textarea",{value:h,onChange:e=>b(e.target.value),rows:4,disabled:M,className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400"})]}),v?r.jsx("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:v}):null,(0,r.jsxs)("div",{className:"flex flex-wrap gap-3",children:[M?null:(0,r.jsxs)(r.Fragment,{children:[r.jsx("button",{type:"submit",disabled:y,className:"rounded-xl bg-slate-900 px-5 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70",children:y?"กำลังบันทึก...":"บันทึก"}),r.jsx("button",{type:"button",onClick:$,disabled:y,className:"rounded-xl border border-red-200 px-5 py-2 text-sm font-medium text-red-600 shadow-sm transition hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-70",children:"ลบงาน"})]}),r.jsx(o.default,{href:"/",className:"rounded-xl border border-slate-200 px-5 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"กลับ"})]})]}),r.jsx(i.Z,{job:w,open:S,onOpenChange:k,onJobUpdate:(e,t)=>B(t)}),r.jsx(d.Z,{isOpen:C,title:"ยืนยันปิดงาน?",onClose:()=>E(!1),children:(0,r.jsxs)("div",{className:"flex flex-col gap-4",children:[r.jsx("p",{className:"text-sm text-slate-600",children:'ปิดงานแล้วจะถูกย้ายไปที่ "งานที่ปิดแล้ว" และไม่สามารถแก้ไขได้'}),O?r.jsx("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:O}):null,(0,r.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[r.jsx("button",{type:"button",onClick:()=>E(!1),className:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"ยกเลิก"}),r.jsx("button",{type:"button",onClick:K,disabled:P,className:"rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70",children:P?"กำลังปิดงาน...":"ยืนยันปิดงาน"})]})]})})]})}},8168:(e,t,s)=>{"use strict";s.d(t,{Z:()=>o});var r=s(326),a=s(3217);let l=e=>{let t=e?.trim();if(!t)return{status:"empty"};let s=/^https?:\/\//i.test(t)?t:`https://${t}`;try{let e=new URL(s);if("http:"!==e.protocol&&"https:"!==e.protocol)return{status:"invalid"};return{status:"valid",url:e.toString()}}catch{return{status:"invalid"}}};function o({url:e,label:t="เปิด My Map",className:s=""}){let o=l(e),n=s?` ${s}`:"";if("valid"===o.status)return r.jsx("a",{href:o.url,target:"_blank",rel:"noopener noreferrer",className:`inline-flex items-center ${a.hV}${n}`,children:t});let i="empty"===o.status?"ไม่มีลิงก์แผนที่":"ลิงก์ไม่ถูกต้อง";return r.jsx("span",{className:`text-sm text-slate-400${n}`,children:i})}},7687:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});var r=s(326);function a({isOpen:e,title:t,onClose:s,children:a}){return e?(0,r.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center px-4",children:[r.jsx("div",{className:"absolute inset-0 bg-slate-900/40",onClick:s,role:"presentation"}),(0,r.jsxs)("div",{className:"relative z-10 w-full max-w-lg rounded-xl bg-white p-6 shadow-xl",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[t?r.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:t}):null,r.jsx("button",{type:"button",onClick:s,className:"text-sm text-slate-500 hover:text-slate-700",children:"ปิด"})]}),r.jsx("div",{className:"mt-4",children:a})]})]}):null}},9068:(e,t,s)=>{"use strict";s.d(t,{Z:()=>o});var r=s(326),a=s(7577),l=s(7687);function o({open:e,onOpenChange:t,job:s,onJobUpdate:o}){let[n,i]=(0,a.useState)(""),[d,u]=(0,a.useState)(""),[c,x]=(0,a.useState)(""),[m,p]=(0,a.useState)({}),[h,b]=(0,a.useState)(!1),[f,g]=(0,a.useState)(null),y=async()=>{if(!s)return;let e={},r=c.trim();if(n||(e.noticeDate="กรุณาระบุวันที่จะไปดำเนินการแจ้ง"),d.trim()||(e.noticeBy="กรุณาระบุผู้แจ้ง"),r){let t=/^https?:\/\//i.test(r)?r:`https://${r}`;try{let e=new URL(t);if("http:"!==e.protocol&&"https:"!==e.protocol)throw Error("invalid protocol")}catch{e.mymapsUrl="ลิ้งไม่ถูกต้อง"}}else e.mymapsUrl="กรุณาระบุลิ้ง my map";if(Object.keys(e).length>0){p(e);return}b(!0),p({});try{let e=/^https?:\/\//i.test(r)?r:`https://${r}`,a={jobId:s.id,notice_date:n,notice_by:d.trim(),mymaps_url:e},l=await fetch("/api/jobs/notice-schedule",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),i=await l.json().catch(()=>null);if(!l.ok||!i?.ok)throw Error(i?.error??"ไม่สามารถบันทึกกำหนดการได้");let u=i.notice_scheduled_at??new Date().toISOString();o?.(s.id,{notice_status:"SCHEDULED",notice_date:a.notice_date,notice_by:a.notice_by,mymaps_url:a.mymaps_url,notice_scheduled_at:u}),g("กำหนดการแจ้งเรียบร้อยแล้ว"),setTimeout(()=>{t(!1)},800)}catch(e){console.error("Notice schedule failed",e),p({submit:"บันทึกกำหนดการไม่สำเร็จ กรุณาลองใหม่"})}finally{b(!1)}};return r.jsx(l.Z,{isOpen:e,title:"แจ้งหนังสือดับไฟ",onClose:()=>t(!1),children:(0,r.jsxs)("div",{className:"flex flex-col gap-4",children:[f?r.jsx("div",{className:"rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-2 text-sm text-emerald-700",children:f}):null,(0,r.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["วันที่จะไปดำเนินการแจ้ง",r.jsx("input",{type:"date",value:n,onChange:e=>i(e.target.value),className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0}),m.noticeDate?r.jsx("span",{className:"text-xs text-red-600",children:m.noticeDate}):null]}),(0,r.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["ผู้แจ้ง",r.jsx("input",{type:"text",value:d,onChange:e=>u(e.target.value),className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0}),m.noticeBy?r.jsx("span",{className:"text-xs text-red-600",children:m.noticeBy}):null]}),(0,r.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["ลิ้ง my map",r.jsx("input",{type:"url",value:c,onChange:e=>x(e.target.value),placeholder:"https://",className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0}),m.mymapsUrl?r.jsx("span",{className:"text-xs text-red-600",children:m.mymapsUrl}):null]}),m.submit?r.jsx("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:m.submit}):null,(0,r.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[r.jsx("button",{type:"button",onClick:()=>t(!1),className:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"ยกเลิก"}),r.jsx("button",{type:"button",onClick:y,disabled:h,className:"rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70",children:h?"กำลังบันทึก...":"บันทึกกำหนดการ"})]})]})})}},8927:(e,t,s)=>{"use strict";s.d(t,{Cq:()=>l,DQ:()=>a,Z6:()=>n,gK:()=>o,uA:()=>i});var r=s(1632);async function a(){return r.O.from("outage_jobs").select("*").order("outage_date",{ascending:!0})}async function l(e){return r.O.from("outage_jobs").insert({outage_date:e.outage_date,equipment_code:e.equipment_code,note:e.note??null})}async function o(e,t){return r.O.from("outage_jobs").update({outage_date:t.outage_date,equipment_code:t.equipment_code,note:t.note??null}).eq("id",e)}async function n(e,t){return r.O.from("outage_jobs").update({nakhon_status:"NOTIFIED",nakhon_notified_date:t.date,nakhon_memo_no:t.memoNo}).eq("id",e)}async function i(e){return r.O.from("outage_jobs").update({nakhon_status:"NOT_REQUIRED",nakhon_notified_date:null,nakhon_memo_no:null}).eq("id",e)}},1632:(e,t,s)=>{"use strict";s.d(t,{O:()=>r});let r=(0,s(9701).e)()},9701:(e,t,s)=>{"use strict";s.d(t,{X:()=>u,e:()=>d});var r=s(5157);let a="https://yhkrzepnokhiqbxwhkgz.supabase.co",l="sb_publishable_CdTtNwP3k39LxhkLkKbS3w_Y3co_tFE",o=null,n=()=>{if(!a||!l)throw Error("Missing Supabase env vars. Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY.")},i=async(e,t)=>{},d=()=>(n(),o||(o=(0,r.eI)(a,l)),o),u=async e=>{await i(e.access_token,e.refresh_token)}},3217:(e,t,s)=>{"use strict";s.d(t,{MY:()=>o,SK:()=>n,We:()=>r,cS:()=>u,cX:()=>i,hV:()=>d,pU:()=>a,uI:()=>l});let r="min-h-screen bg-slate-50",a="rounded-2xl border border-slate-200/60 bg-white/80 shadow-sm transition hover:shadow-md",l="bg-violet-600 text-white hover:bg-violet-700 focus-visible:ring-violet-300",o=`inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-medium shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 ${l}`,n="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-slate-100/60 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-violet-300 focus-visible:ring-offset-2",i="rounded-xl border border-slate-200/80 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm outline-none transition focus:border-violet-500 focus-visible:ring-2 focus-visible:ring-violet-200",d="text-sm font-medium text-violet-600 underline-offset-4 transition hover:text-violet-700 hover:underline",u=e=>{switch(e){case"RED":return"border border-rose-200/80 bg-rose-50 text-rose-700";case"YELLOW":return"border border-amber-200/80 bg-amber-50 text-amber-700";default:return"border border-emerald-200/80 bg-emerald-50 text-emerald-700"}}},5118:(e,t,s)=>{"use strict";s.r(t),s.d(t,{$$typeof:()=>o,__esModule:()=>l,default:()=>n});var r=s(8570);let a=(0,r.createProxy)(String.raw`C:\Users\506870\Desktop\KB-outage\src\app\job\[id]\page.tsx`),{__esModule:l,$$typeof:o}=a;a.default;let n=(0,r.createProxy)(String.raw`C:\Users\506870\Desktop\KB-outage\src\app\job\[id]\page.tsx#default`)},2029:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>l,metadata:()=>a});var r=s(9510);s(5023);let a={title:"Krabi Outage Tracker",description:"Track planned outages in Krabi."};function l({children:e}){return r.jsx("html",{lang:"th",children:r.jsx("body",{children:r.jsx("div",{className:"min-h-screen",children:r.jsx("main",{className:"mx-auto flex w-full max-w-5xl flex-col px-4 py-8",children:e})})})})}},5023:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[948,471,313,434],()=>s(2840));module.exports=r})();