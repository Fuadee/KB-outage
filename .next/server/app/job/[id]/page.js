(()=>{var e={};e.id=534,e.ids=[534],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},2840:(e,s,t)=>{"use strict";t.r(s),t.d(s,{GlobalError:()=>n.a,__next_app__:()=>x,originalPathname:()=>u,pages:()=>c,routeModule:()=>p,tree:()=>d}),t(5118),t(2029),t(5866);var r=t(3191),a=t(8716),l=t(7922),n=t.n(l),i=t(5231),o={};for(let e in i)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(o[e]=()=>i[e]);t.d(s,o);let d=["",{children:["job",{children:["[id]",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(t.bind(t,5118)),"C:\\Users\\506870\\Desktop\\KB-outage\\src\\app\\job\\[id]\\page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(t.bind(t,2029)),"C:\\Users\\506870\\Desktop\\KB-outage\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(t.t.bind(t,5866,23)),"next/dist/client/components/not-found-error"]}],c=["C:\\Users\\506870\\Desktop\\KB-outage\\src\\app\\job\\[id]\\page.tsx"],u="/job/[id]/page",x={require:t,loadChunk:()=>Promise.resolve()},p=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/job/[id]/page",pathname:"/job/[id]",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},6899:(e,s,t)=>{Promise.resolve().then(t.bind(t,6163))},6163:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>g});var r=t(326),a=t(7577),l=t(5047),n=t(434),i=t(4029),o=t(9068),d=t(7687),c=t(6792),u=t(9837),x=t(5329),p=t(9175),m=t(8927),h=t(1632);function g(){let e=(0,l.useRouter)(),s=(0,l.useParams)(),[t,g]=(0,a.useState)(""),[j,f]=(0,a.useState)(""),[b,y]=(0,a.useState)(""),[v,N]=(0,a.useState)(!0),[_,S]=(0,a.useState)(!1),[w,C]=(0,a.useState)(null),[Z,k]=(0,a.useState)(null),[E,P]=(0,a.useState)(!1),[D,q]=(0,a.useState)(!1),[O,U]=(0,a.useState)(!1),[T,K]=(0,a.useState)(null),[$,A]=(0,a.useState)(null),B=async r=>{if(r.preventDefault(),!s.id||Z?.is_closed)return;if(C(null),!t||!j.trim()){C("กรุณากรอกวันที่และรหัสอุปกรณ์");return}S(!0);let{error:a}=await (0,m.gK)(s.id,{outage_date:t,equipment_code:j.trim(),note:b.trim()?b.trim():null});if(a){C(a.message),S(!1);return}S(!1),e.push("/")},L=async()=>{if(s.id&&!Z?.is_closed){S(!0),C(null);try{let t=await fetch(`/api/jobs/${s.id}/delete`,{method:"DELETE"}),r=await t.json().catch(()=>null);if(!t.ok||!r?.ok||0===r.deletedCount){let e=r?.error??"ลบไม่สำเร็จ (สิทธิไม่อนุญาตหรือไม่พบรายการ)";C(e),A({message:e,tone:"error"}),S(!1);return}e.push("/")}catch(s){let e=s instanceof Error?s.message:"ลบไม่สำเร็จ (สิทธิไม่อนุญาตหรือไม่พบรายการ)";C(e),A({message:e,tone:"error"})}finally{S(!1)}}},M=e=>{k(s=>s?{...s,...e}:s)},G=async()=>{if(!Z)return;U(!0),K(null);let{data:s}=await h.O.auth.getSession();if(!s.session){U(!1),q(!1),e.push("/login");return}try{let s=await fetch(`/api/jobs/${Z.id}/close`,{method:"POST",headers:{"Content-Type":"application/json"}});if(401===s.status){U(!1),q(!1),e.push("/login");return}let t=await s.json().catch(()=>null);if(!s.ok||!t?.ok)throw Error(t?.error??"ปิดงานไม่สำเร็จ กรุณาลองใหม่");A({message:"✅ ปิดงานเรียบร้อย",tone:"success"}),k(e=>e?{...e,is_closed:!0,closed_at:t.closed_at??new Date().toISOString()}:e),q(!1)}catch(s){let e=s instanceof Error?s.message:"ปิดงานไม่สำเร็จ กรุณาลองใหม่";K(e),A({message:e,tone:"error"})}finally{U(!1)}};if(v)return r.jsx("div",{className:"rounded-2xl border border-slate-200 bg-white px-4 py-8 text-center text-sm text-slate-500 shadow-sm",children:"กำลังโหลดข้อมูล..."});let H=Z?.is_closed??!1,Y=(Z?.notice_status??"NONE")==="SCHEDULED"&&!H;return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("header",{className:"space-y-3",children:[r.jsx("p",{className:"text-xs font-semibold uppercase tracking-[0.3em] text-slate-400",children:"Job detail"}),(0,r.jsxs)("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between",children:[(0,r.jsxs)("div",{className:"space-y-2",children:[r.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-900",children:H?"รายละเอียดงาน":"แก้ไขงาน"}),r.jsx("p",{className:"text-sm text-slate-600",children:H?"งานนี้ถูกปิดแล้วและไม่สามารถแก้ไขได้":"ปรับปรุงรายละเอียดหรือลบงานนี้ออกจากระบบ"}),H?(0,r.jsxs)("div",{className:"text-sm text-slate-600",children:["ปิดเมื่อ"," ",r.jsx("span",{className:"font-medium text-slate-800",children:Z?.closed_at?new Date(Z.closed_at).toLocaleString("th-TH",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-"})]}):null]}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[Z?.social_status!=="POSTED"||H?null:r.jsx(u.Z,{type:"button",variant:"secondary",size:"sm",onClick:()=>P(!0),children:(Z.notice_status??"NONE")==="SCHEDULED"?"กำหนดการแจ้งเรียบร้อยแล้ว (แก้ไขได้)":"แจ้งหนังสือดับไฟ"}),Y?r.jsx(u.Z,{type:"button",size:"sm",onClick:()=>{K(null),q(!0)},children:"ปิดงาน"}):null,r.jsx(c.Z,{variant:H?"neutral":"accent",children:H?"Closed":"Active"})]})]}),$?r.jsx(x.Zb,{className:`${"success"===$.tone?"border-emerald-200 bg-emerald-50/80":"border-rose-200 bg-rose-50/80"}`,children:r.jsx(x.aY,{className:`py-3 text-sm ${"success"===$.tone?"text-emerald-700":"text-rose-700"}`,children:$.message})}):null]}),(0,r.jsxs)("div",{className:"grid gap-6 lg:grid-cols-[minmax(0,1fr)_320px]",children:[(0,r.jsxs)(x.Zb,{children:[(0,r.jsxs)(x.Ol,{children:[r.jsx(x.ll,{children:"รายละเอียดงาน"}),r.jsx(x.SZ,{children:"ข้อมูลพื้นฐานและหมายเหตุเพิ่มเติม"})]}),r.jsx(x.aY,{children:(0,r.jsxs)("form",{onSubmit:B,className:"flex flex-col gap-6",children:[(0,r.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["วันที่ดับไฟ",r.jsx(p.Z,{type:"date",value:t,onChange:e=>g(e.target.value),disabled:H,required:!0})]}),(0,r.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["รหัสอุปกรณ์",r.jsx(p.Z,{type:"text",value:j,onChange:e=>f(e.target.value),disabled:H,required:!0})]}),(0,r.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["หมายเหตุเพิ่มเติม",r.jsx("textarea",{value:b,onChange:e=>y(e.target.value),rows:4,disabled:H,className:"w-full rounded-xl border border-slate-200/80 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm transition focus:border-fuchsia-400 focus:outline-none focus:ring-2 focus:ring-fuchsia-200"})]}),w?r.jsx("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:w}):null,(0,r.jsxs)("div",{className:"flex flex-wrap gap-3",children:[H?null:(0,r.jsxs)(r.Fragment,{children:[r.jsx(u.Z,{type:"submit",disabled:_,children:_?"กำลังบันทึก...":"บันทึก"}),r.jsx(u.Z,{type:"button",variant:"secondary",disabled:_,onClick:L,className:"border-rose-200 text-rose-600 hover:bg-rose-50",children:"ลบงาน"})]}),r.jsx(n.default,{href:"/",className:"inline-flex items-center justify-center rounded-full border border-slate-200 px-5 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"กลับ"})]})]})})]}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)(x.Zb,{children:[(0,r.jsxs)(x.Ol,{children:[r.jsx(x.ll,{children:"ลิงก์แผนที่"}),r.jsx(x.SZ,{children:"เข้าถึงแผนที่และจุดงาน"})]}),r.jsx(x.aY,{children:r.jsx(i.Z,{googleUrl:Z?.map_link,myMapUrl:Z?.mymaps_url,className:"mt-3"})})]}),(0,r.jsxs)(x.Zb,{children:[(0,r.jsxs)(x.Ol,{children:[r.jsx(x.ll,{children:"การดำเนินการ"}),r.jsx(x.SZ,{children:"งานที่เกี่ยวข้องกับสถานะนี้"})]}),(0,r.jsxs)(x.aY,{className:"space-y-3",children:[Z?.social_status!=="POSTED"||H?r.jsx(c.Z,{variant:"default",children:"รอการโพสต์ Social"}):r.jsx(u.Z,{type:"button",variant:"secondary",className:"w-full",onClick:()=>P(!0),children:(Z.notice_status??"NONE")==="SCHEDULED"?"กำหนดการแจ้งเรียบร้อยแล้ว (แก้ไขได้)":"แจ้งหนังสือดับไฟ"}),Y?r.jsx(u.Z,{type:"button",className:"w-full",onClick:()=>{K(null),q(!0)},children:"ปิดงาน"}):r.jsx(c.Z,{variant:"neutral",children:"ยังไม่พร้อมปิดงาน"})]})]})]})]}),r.jsx(o.Z,{job:Z,open:E,onOpenChange:P,onJobUpdate:(e,s)=>M(s)}),r.jsx(d.Z,{isOpen:D,title:"ยืนยันปิดงาน?",onClose:()=>q(!1),children:(0,r.jsxs)("div",{className:"flex flex-col gap-4",children:[r.jsx("p",{className:"text-sm text-slate-600",children:'ปิดงานแล้วจะถูกย้ายไปที่ "งานที่ปิดแล้ว" และไม่สามารถแก้ไขได้'}),T?r.jsx("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:T}):null,(0,r.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[r.jsx(u.Z,{type:"button",variant:"secondary",onClick:()=>q(!1),children:"ยกเลิก"}),r.jsx(u.Z,{type:"button",onClick:G,disabled:O,children:O?"กำลังปิดงาน...":"ยืนยันปิดงาน"})]})]})})]})}},5118:(e,s,t)=>{"use strict";t.r(s),t.d(s,{$$typeof:()=>n,__esModule:()=>l,default:()=>i});var r=t(8570);let a=(0,r.createProxy)(String.raw`C:\Users\506870\Desktop\KB-outage\src\app\job\[id]\page.tsx`),{__esModule:l,$$typeof:n}=a;a.default;let i=(0,r.createProxy)(String.raw`C:\Users\506870\Desktop\KB-outage\src\app\job\[id]\page.tsx#default`)}};var s=require("../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[948,471,496,157,221],()=>t(2840));module.exports=r})();