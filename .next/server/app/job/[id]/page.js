(()=>{var e={};e.id=534,e.ids=[534],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},2840:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>o.a,__next_app__:()=>x,originalPathname:()=>c,pages:()=>u,routeModule:()=>m,tree:()=>i}),s(5118),s(2029),s(5866);var r=s(3191),a=s(8716),l=s(7922),o=s.n(l),n=s(5231),d={};for(let e in n)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(d[e]=()=>n[e]);s.d(t,d);let i=["",{children:["job",{children:["[id]",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,5118)),"C:\\Users\\506870\\Desktop\\KB-outage\\src\\app\\job\\[id]\\page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,2029)),"C:\\Users\\506870\\Desktop\\KB-outage\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,5866,23)),"next/dist/client/components/not-found-error"]}],u=["C:\\Users\\506870\\Desktop\\KB-outage\\src\\app\\job\\[id]\\page.tsx"],c="/job/[id]/page",x={require:s,loadChunk:()=>Promise.resolve()},m=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/job/[id]/page",pathname:"/job/[id]",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:i}})},6899:(e,t,s)=>{Promise.resolve().then(s.bind(s,6163))},6163:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>x});var r=s(326),a=s(7577),l=s(5047),o=s(434),n=s(4029),d=s(9068),i=s(7687),u=s(8927),c=s(1632);function x(){let e=(0,l.useRouter)(),t=(0,l.useParams)(),[s,x]=(0,a.useState)(""),[m,p]=(0,a.useState)(""),[b,h]=(0,a.useState)(""),[g,f]=(0,a.useState)(!0),[j,y]=(0,a.useState)(!1),[w,v]=(0,a.useState)(null),[N,_]=(0,a.useState)(null),[S,C]=(0,a.useState)(!1),[P,k]=(0,a.useState)(!1),[E,q]=(0,a.useState)(!1),[D,U]=(0,a.useState)(null),[O,K]=(0,a.useState)(null),T=async r=>{if(r.preventDefault(),!t.id||N?.is_closed)return;if(v(null),!s||!m.trim()){v("กรุณากรอกวันที่และรหัสอุปกรณ์");return}y(!0);let{error:a}=await (0,u.gK)(t.id,{outage_date:s,equipment_code:m.trim(),note:b.trim()?b.trim():null});if(a){v(a.message),y(!1);return}y(!1),e.push("/")},B=async()=>{if(t.id&&!N?.is_closed){y(!0),v(null);try{let s=await fetch(`/api/jobs/${t.id}/delete`,{method:"DELETE"}),r=await s.json().catch(()=>null);if(!s.ok||!r?.ok||0===r.deletedCount){let e=r?.error??"ลบไม่สำเร็จ (สิทธิไม่อนุญาตหรือไม่พบรายการ)";v(e),K({message:e,tone:"error"}),y(!1);return}e.push("/")}catch(t){let e=t instanceof Error?t.message:"ลบไม่สำเร็จ (สิทธิไม่อนุญาตหรือไม่พบรายการ)";v(e),K({message:e,tone:"error"})}finally{y(!1)}}},M=e=>{_(t=>t?{...t,...e}:t)},$=async()=>{if(!N)return;q(!0),U(null);let{data:t}=await c.O.auth.getSession();if(!t.session){q(!1),k(!1),e.push("/login");return}try{let t=await fetch(`/api/jobs/${N.id}/close`,{method:"POST",headers:{"Content-Type":"application/json"}});if(401===t.status){q(!1),k(!1),e.push("/login");return}let s=await t.json().catch(()=>null);if(!t.ok||!s?.ok)throw Error(s?.error??"ปิดงานไม่สำเร็จ กรุณาลองใหม่");K({message:"✅ ปิดงานเรียบร้อย",tone:"success"}),_(e=>e?{...e,is_closed:!0,closed_at:s.closed_at??new Date().toISOString()}:e),k(!1)}catch(t){let e=t instanceof Error?t.message:"ปิดงานไม่สำเร็จ กรุณาลองใหม่";U(e),K({message:e,tone:"error"})}finally{q(!1)}};if(g)return r.jsx("div",{className:"rounded-2xl border border-slate-200 bg-white px-4 py-8 text-center text-sm text-slate-500 shadow-sm",children:"กำลังโหลดข้อมูล..."});let A=N?.is_closed??!1,G=(N?.notice_status??"NONE")==="SCHEDULED"&&!A;return(0,r.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,r.jsxs)("header",{className:"flex flex-col gap-2",children:[r.jsx("h1",{className:"text-2xl font-semibold",children:A?"รายละเอียดงาน":"แก้ไขงาน"}),r.jsx("p",{className:"text-sm text-slate-500",children:A?"งานนี้ถูกปิดแล้วและไม่สามารถแก้ไขได้":"ปรับปรุงรายละเอียดหรือลบงานนี้ออกจากระบบ"}),O?r.jsx("div",{className:`mt-2 rounded-xl border px-4 py-3 text-sm ${"success"===O.tone?"border-emerald-200 bg-emerald-50 text-emerald-700":"border-red-200 bg-red-50 text-red-700"}`,children:O.message}):null,A?(0,r.jsxs)("div",{className:"mt-2 text-sm text-slate-600",children:["ปิดเมื่อ"," ",r.jsx("span",{className:"font-medium text-slate-800",children:N?.closed_at?new Date(N.closed_at).toLocaleString("th-TH",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-"})]}):null,(0,r.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2",children:[N?.social_status!=="POSTED"||A?null:r.jsx("button",{type:"button",onClick:()=>C(!0),className:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:(N.notice_status??"NONE")==="SCHEDULED"?"กำหนดการแจ้งเรียบร้อยแล้ว (แก้ไขได้)":"แจ้งหนังสือดับไฟ"}),G?r.jsx("button",{type:"button",onClick:()=>{U(null),k(!0)},className:"rounded-xl bg-amber-500 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-amber-400",children:"ปิดงาน"}):null]})]}),(0,r.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm",children:[r.jsx("h2",{className:"text-sm font-semibold text-slate-700",children:"ลิงก์แผนที่"}),r.jsx(n.Z,{googleUrl:N?.map_link,myMapUrl:N?.mymaps_url,className:"mt-3"})]}),(0,r.jsxs)("form",{onSubmit:T,className:"flex flex-col gap-6 rounded-2xl bg-white p-6 shadow-sm",children:[(0,r.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["วันที่ดับไฟ",r.jsx("input",{type:"date",value:s,onChange:e=>x(e.target.value),disabled:A,className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0})]}),(0,r.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["รหัสอุปกรณ์",r.jsx("input",{type:"text",value:m,onChange:e=>p(e.target.value),disabled:A,className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0})]}),(0,r.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["หมายเหตุเพิ่มเติม",r.jsx("textarea",{value:b,onChange:e=>h(e.target.value),rows:4,disabled:A,className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400"})]}),w?r.jsx("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:w}):null,(0,r.jsxs)("div",{className:"flex flex-wrap gap-3",children:[A?null:(0,r.jsxs)(r.Fragment,{children:[r.jsx("button",{type:"submit",disabled:j,className:"rounded-xl bg-slate-900 px-5 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70",children:j?"กำลังบันทึก...":"บันทึก"}),r.jsx("button",{type:"button",onClick:B,disabled:j,className:"rounded-xl border border-red-200 px-5 py-2 text-sm font-medium text-red-600 shadow-sm transition hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-70",children:"ลบงาน"})]}),r.jsx(o.default,{href:"/",className:"rounded-xl border border-slate-200 px-5 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"กลับ"})]})]}),r.jsx(d.Z,{job:N,open:S,onOpenChange:C,onJobUpdate:(e,t)=>M(t)}),r.jsx(i.Z,{isOpen:P,title:"ยืนยันปิดงาน?",onClose:()=>k(!1),children:(0,r.jsxs)("div",{className:"flex flex-col gap-4",children:[r.jsx("p",{className:"text-sm text-slate-600",children:'ปิดงานแล้วจะถูกย้ายไปที่ "งานที่ปิดแล้ว" และไม่สามารถแก้ไขได้'}),D?r.jsx("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:D}):null,(0,r.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[r.jsx("button",{type:"button",onClick:()=>k(!1),className:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"ยกเลิก"}),r.jsx("button",{type:"button",onClick:$,disabled:E,className:"rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70",children:E?"กำลังปิดงาน...":"ยืนยันปิดงาน"})]})]})})]})}},5118:(e,t,s)=>{"use strict";s.r(t),s.d(t,{$$typeof:()=>o,__esModule:()=>l,default:()=>n});var r=s(8570);let a=(0,r.createProxy)(String.raw`C:\Users\506870\Desktop\KB-outage\src\app\job\[id]\page.tsx`),{__esModule:l,$$typeof:o}=a;a.default;let n=(0,r.createProxy)(String.raw`C:\Users\506870\Desktop\KB-outage\src\app\job\[id]\page.tsx#default`)}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[948,471,313,434,604],()=>s(2840));module.exports=r})();