"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[507],{4507:function(e,t,l){l.r(t),l.d(t,{default:function(){return C}});var a=l(7437),s=l(7138),n=l(6463),o=l(2265),i=l(4347),r=l(9320),d=l(3442);function c(e){let{options:t,value:l,onChange:s,className:n=""}=e;return(0,a.jsx)("div",{role:"group",className:"inline-flex items-center rounded-full bg-slate-100 p-1 text-sm shadow-inner ".concat(n?" ".concat(n):""),children:t.map(e=>{let t=l===e.id;return(0,a.jsx)("button",{type:"button",onClick:()=>s(e.id),className:"rounded-full px-4 py-1.5 text-sm font-medium transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-violet-300 focus-visible:ring-offset-2 ".concat(t?"bg-white text-slate-900 shadow-sm":"text-slate-600 hover:text-slate-900"),children:e.label},e.id)})})}function u(e){return new Date("".concat(e,"T00:00:00"))}function m(e){let t=new Date(e);return t.setHours(0,0,0,0),t}function x(e){var t;let l=function(e,t){let l=m(e).getTime();return Math.round((m(t).getTime()-l)/864e5)}(m(new Date),m(u(e.outage_date))),a=l<0?"เลยกำหนด ".concat(Math.abs(l)," วัน"):0===l?"วันนี้":1===l?"พรุ่งนี้":"เหลือ ".concat(l," วัน");return l<0?{daysLeft:l,color:"RED",label:a}:"PENDING"===(null!==(t=e.nakhon_status)&&void 0!==t?t:"PENDING")?l<14?{daysLeft:l,color:"RED",label:a}:l<=28?{daysLeft:l,color:"YELLOW",label:a}:{daysLeft:l,color:"GREEN",label:a}:l<3?{daysLeft:l,color:"RED",label:a}:l<=6?{daysLeft:l,color:"YELLOW",label:a}:{daysLeft:l,color:"GREEN",label:a}}let p=["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"];function f(e){var t,l,a,s,n,o;let i=null!==(t=e.doc_purpose)&&void 0!==t?t:"",r=null!==(l=e.doc_area_title)&&void 0!==l?l:"",d=null!==(a=e.doc_time_start)&&void 0!==a?a:"",c=null!==(s=e.doc_time_end)&&void 0!==s?s:"",m=null!==(n=e.doc_area_detail)&&void 0!==n?n:"",x=null!==(o=e.map_link)&&void 0!==o?o:"",f=function(e){var t;if(!e)return"";let l=u(e),a=l.getDate(),s=null!==(t=p[l.getMonth()])&&void 0!==t?t:"",n=l.getFullYear()+543;return"".concat(a," ").concat(s," ").concat(n).trim()}(e.outage_date);return["เพื่อ".concat(i," บริเวณ ").concat(r),"\uD83D\uDCC5".concat(f),"☣️โซนสีเหลือง แสดงพื้นที่ไฟดับ ตั้งแต่เวลา ".concat(d," .- ").concat(c," น."),"\uD83C\uDF0Fบริเวณพื้นที่ผู้ใช้ไฟได้รับผลกระทบ ".concat(m),"\uD83D\uDCCCกดลิ้งค์ \uD83D\uDC47 เพื่อตรวจสอบพื้นที่ไฟดับ ".concat(x)].join("\n")}function h(e){var t;let{job:l,isOpen:s,onClose:n,onJobUpdate:d}=e,[c,u]=(0,o.useState)(!1),[m,x]=(0,o.useState)(null),p=(0,o.useMemo)(()=>{var e;return l?(null===(e=l.social_post_text)||void 0===e?void 0:e.trim())?l.social_post_text:f(l):""},[l]);(0,o.useEffect)(()=>{if(!m)return;let e=window.setTimeout(()=>{x(null)},3e3);return()=>window.clearTimeout(e)},[m]);let h=async function(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];if(p)try{await navigator.clipboard.writeText(p),e&&x("คัดลอกข้อความแล้ว — ไปวางใน Facebook/LINE ได้เลย")}catch(t){console.error("Failed to copy text",t),e&&x("คัดลอกข้อความไม่สำเร็จ กรุณาลองใหม่")}},_=async()=>{if(l&&p){if("POSTED"===l.social_status){await h();return}u(!0);try{var e,t,a,s,o,i;let r=await fetch("/api/jobs/social-post",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jobId:l.id})}),c=await r.json().catch(()=>null);if(!r.ok||!(null==c?void 0:c.ok))throw Error(null!==(e=null==c?void 0:c.error)&&void 0!==e?e:"ไม่สามารถโพสต์ข้อความได้");let u=null!==(t=c.social_posted_at)&&void 0!==t?t:new Date().toISOString(),m=null!==(s=null!==(a=c.social_post_text)&&void 0!==a?a:c.preview_text)&&void 0!==s?s:f(l);d(l.id,{...null!==(o=c.job)&&void 0!==o?o:{},social_status:null!==(i=c.social_status)&&void 0!==i?i:"POSTED",social_post_text:m,social_posted_at:u}),h(!1),x("โพสต์ข้อความสำเร็จแล้ว"),window.setTimeout(()=>{n()},500)}catch(e){console.error("Social post failed",e),x("โพสต์ข้อความไม่สำเร็จ กรุณาลองใหม่")}finally{u(!1)}}};return(0,a.jsx)(r.Z,{isOpen:s,title:"ตัวอย่างข้อความโพสต์ Social",onClose:n,children:(0,a.jsxs)("div",{className:"flex flex-col gap-4",children:[m?(0,a.jsx)("div",{className:"rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-2 text-sm text-emerald-700",children:m}):null,(0,a.jsx)("div",{className:"rounded-xl border border-slate-200 bg-slate-50 p-3 text-sm text-slate-700",children:(0,a.jsx)("p",{className:"whitespace-pre-wrap leading-relaxed",children:p||"-"})}),(0,a.jsx)("div",{className:"rounded-xl border border-slate-200 bg-white p-3",children:(0,a.jsxs)("div",{className:"flex flex-col gap-1 text-xs text-slate-500",children:[(0,a.jsx)("span",{children:"ลิ้ง Google Map"}),(0,a.jsx)(i.Z,{url:null!==(t=null==l?void 0:l.map_link)&&void 0!==t?t:void 0,label:"เปิด Google Map"})]})}),(0,a.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[(0,a.jsx)("button",{type:"button",onClick:()=>void h(!0),className:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"คัดลอกข้อความ"}),(0,a.jsx)("button",{type:"button",onClick:_,disabled:c||!p,className:"rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70",children:c?"กำลังโพสต์...":"Post ลงสื่อ social"})]})]})})}var _=l(836);function b(e){let{status:t,label:l}=e;return(0,a.jsx)("span",{className:"rounded-full px-3 py-1 text-xs font-semibold ".concat((0,_.cS)(t)),children:l})}var v=l(1707),g=l(3866);let j=e=>{var t;if(!e)return null;let l=e.match(/filename\*=UTF-8''([^;]+)/i);if(null==l?void 0:l[1])try{return decodeURIComponent(l[1])}catch(e){return l[1]}let a=e.match(/filename="?([^";]+)"?/i);return null!==(t=null==a?void 0:a[1])&&void 0!==t?t:null},N=e=>{var t,l,a;if("PENDING"===(null!==(t=e.nakhon_status)&&void 0!==t?t:"PENDING"))return"notify_nakhon";if(!("GENERATED"===e.doc_status||e.doc_generated_at))return"create_doc";let s=null!==(l=e.social_status)&&void 0!==l?l:"DRAFT";if("PENDING_APPROVAL"===s)return"wait_approval";let n=null!==(a=e.notice_status)&&void 0!==a?a:"NONE";return"POSTED"===s&&"SCHEDULED"!==n?"notify_outage_letter":"close_job"},y={notify_nakhon:"แจ้งศูนย์นคร",create_doc:"สร้างเอกสารดับไฟ",wait_approval:"รออนุมัติ",notify_outage_letter:"แจ้งหนังสือดับไฟ",close_job:"ปิดงาน"},w="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-medium shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2",k="".concat(w," ").concat(_.uI),E="".concat(w," border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 focus-visible:ring-slate-200"),S="disabled:cursor-not-allowed disabled:opacity-60";function C(){let e=(0,n.useRouter)(),[t,l]=(0,o.useState)([]),[m,p]=(0,o.useState)(!0),[f,w]=(0,o.useState)(null),[C,D]=(0,o.useState)(""),[O,T]=(0,o.useState)("all"),[L,P]=(0,o.useState)("active"),[I,R]=(0,o.useState)(null),[U,q]=(0,o.useState)({}),[A,G]=(0,o.useState)(null),[M,F]=(0,o.useState)(""),[Z,X]=(0,o.useState)(""),[Y,K]=(0,o.useState)({}),[H,B]=(0,o.useState)(!1),[J,W]=(0,o.useState)(null),[Q,V]=(0,o.useState)(null),[z,$]=(0,o.useState)(null),[ee,et]=(0,o.useState)({doc_issue_date:"",doc_purpose:"",doc_area_title:"",doc_time_start:"",doc_time_end:"",doc_area_detail:"",map_link:""}),[el,ea]=(0,o.useState)({}),[es,en]=(0,o.useState)(!1),[eo,ei]=(0,o.useState)(null),[er,ed]=(0,o.useState)(!1),[ec,eu]=(0,o.useState)(null),[em,ex]=(0,o.useState)(null),[ep,ef]=(0,o.useState)(null),eh=async()=>{p(!0),w(null),R(null);let{data:e,error:t}=await (0,v.DQ)();t?(w(t.message),l([])):l(null!=e?e:[]),p(!1)};(0,o.useEffect)(()=>{eh()},[]),(0,o.useEffect)(()=>{(async()=>{var e,t;let{data:l}=await g.O.auth.getUser();ef(null!==(t=null===(e=l.user)||void 0===e?void 0:e.email)&&void 0!==t?t:null)})();let{data:e}=g.O.auth.onAuthStateChange((e,t)=>{var l,a;ef(null!==(a=null==t?void 0:null===(l=t.user)||void 0===l?void 0:l.email)&&void 0!==a?a:null)});return()=>{e.subscription.unsubscribe()}},[]),(0,o.useEffect)(()=>{if(!em)return;let e=window.setTimeout(()=>{ex(null)},2e3);return()=>window.clearTimeout(e)},[em]);let e_=()=>{G(null),F(""),X(""),K({}),B(!1)},eb=()=>{W(null),et({doc_issue_date:"",doc_purpose:"",doc_area_title:"",doc_time_start:"",doc_time_end:"",doc_area_detail:"",map_link:""}),ea({}),en(!1)},ev=()=>{$(null)},eg=e=>{G(e),F(""),X(""),K({})},ej=e=>{var t,l,a,s,n,o,i;W(e),et({doc_issue_date:null!==(t=e.doc_issue_date)&&void 0!==t?t:"",doc_purpose:null!==(l=e.doc_purpose)&&void 0!==l?l:"",doc_area_title:null!==(a=e.doc_area_title)&&void 0!==a?a:"",doc_time_start:null!==(s=e.doc_time_start)&&void 0!==s?s:"",doc_time_end:null!==(n=e.doc_time_end)&&void 0!==n?n:"",doc_area_detail:null!==(o=e.doc_area_detail)&&void 0!==o?o:"",map_link:null!==(i=e.map_link)&&void 0!==i?i:""}),ea({})},eN=e=>{ei(e),ed(!1),eu(null)},ey=async()=>{if(!eo)return;ed(!0),eu(null);let{data:t}=await g.O.auth.getSession();if(!t.session){ed(!1),ei(null),e.push("/login");return}try{let t=await fetch("/api/jobs/".concat(eo.id,"/close"),{method:"POST",headers:{"Content-Type":"application/json"}});if(401===t.status){ed(!1),ei(null),e.push("/login");return}let a=await t.json().catch(()=>null);if(!t.ok||!(null==a?void 0:a.ok)){var l;throw Error(null!==(l=null==a?void 0:a.error)&&void 0!==l?l:"ปิดงานไม่สำเร็จ กรุณาลองใหม่")}ex({message:"✅ ปิดงานเรียบร้อย",tone:"success"}),await eh(),ei(null)}catch(t){let e=t instanceof Error?t.message:"ปิดงานไม่สำเร็จ กรุณาลองใหม่";eu(e),ex({message:e,tone:"error"})}finally{ed(!1)}},ew=async()=>{await g.O.auth.signOut(),await fetch("/api/auth/session",{method:"DELETE"}),e.push("/login")},ek=async()=>{if(!A)return;let e={};if(M||(e.date="กรุณาระบุวันที่แจ้งศูนย์นคร"),Z.trim()||(e.memoNo="กรุณาระบุเลขที่บันทึก"),Object.keys(e).length>0){K(e);return}B(!0),K({});let{error:t}=await (0,v.Z6)(A.id,{date:M,memoNo:Z.trim()});if(t){K({submit:t.message||"บันทึกไม่สำเร็จ กรุณาลองใหม่"}),B(!1);return}l(e=>e.map(e=>e.id===A.id?{...e,nakhon_status:"NOTIFIED",nakhon_notified_date:M,nakhon_memo_no:Z.trim()}:e)),e_()},eE=async e=>{R(null),q(t=>({...t,[e.id]:!0}));let{error:t}=await (0,v.uA)(e.id);if(t){R(t.message||"อัปเดตไม่สำเร็จ"),q(t=>({...t,[e.id]:!1}));return}l(t=>t.map(t=>t.id===e.id?{...t,nakhon_status:"NOT_REQUIRED",nakhon_notified_date:null,nakhon_memo_no:null}:t)),q(t=>({...t,[e.id]:!1}))},eS=async()=>{if(!J)return;let e={};if(ee.doc_issue_date||(e.doc_issue_date="กรุณาระบุวันที่ออกหนังสือ"),ee.doc_purpose.trim()||(e.doc_purpose="กรุณาระบุวัตถุประสงค์"),ee.doc_area_title.trim()||(e.doc_area_title="กรุณาระบุบริเวณที่ดับ"),ee.doc_time_start.trim()||(e.doc_time_start="กรุณาระบุเวลาเริ่มดับไฟ"),ee.doc_time_end.trim()||(e.doc_time_end="กรุณาระบุเวลาจ่ายไฟ"),ee.doc_area_detail.trim()||(e.doc_area_detail="กรุณาระบุรายละเอียดพื้นที่ดับไฟ"),ee.map_link.trim()||(e.map_link="กรุณาระบุลิ้ง google map"),Object.keys(e).length>0){ea(e);return}let t={doc_issue_date:ee.doc_issue_date,doc_purpose:ee.doc_purpose.trim(),doc_area_title:ee.doc_area_title.trim(),doc_time_start:ee.doc_time_start.trim(),doc_time_end:ee.doc_time_end.trim(),doc_area_detail:ee.doc_area_detail.trim(),map_link:ee.map_link.trim()};en(!0),ea({});try{var a,s;let e=await fetch("/api/docs/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jobId:J.id,payload:t})});if(!e.ok){let t=null!==(a=e.headers.get("Content-Type"))&&void 0!==a?a:"",l="";if(t.includes("application/json")){let t=await e.json().catch(()=>null);l=(null==t?void 0:t.error)||(null==t?void 0:t.message)||""}else l=await e.text().catch(()=>"");ea({submit:l?"ไม่สามารถสร้างเอกสารได้ กรุณาลองใหม่ (".concat(l,")"):"ไม่สามารถสร้างเอกสารได้ กรุณาลองใหม่"}),en(!1);return}let n=await e.blob(),o=window.URL.createObjectURL(n),i=null!==(s=j(e.headers.get("Content-Disposition")))&&void 0!==s?s:"outage-doc-".concat(J.id,".docx"),r=document.createElement("a");r.href=o,r.download=i,document.body.appendChild(r),r.click(),r.remove(),window.URL.revokeObjectURL(o);let d=new Date().toISOString();l(e=>e.map(e=>e.id===J.id?{...e,...t,doc_status:"GENERATED",doc_url:null,doc_generated_at:d}:e));try{let e=await fetch("/api/jobs/social-pending",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jobId:J.id})}),t=await e.json().catch(()=>null);e.ok&&(null==t?void 0:t.ok)?l(e=>e.map(e=>e.id===J.id?{...e,social_status:"PENDING_APPROVAL"}:e)):console.warn("Failed to set social pending status",t)}catch(e){console.warn("Failed to set social pending status",e)}eb()}catch(e){console.error(e),ea({submit:"สร้างเอกสารไม่สำเร็จ กรุณาลองใหม่"}),en(!1)}},eC=(0,o.useMemo)(()=>{let e=C.trim().toLowerCase();return t.filter(e=>"closed"===L?e.is_closed:!e.is_closed).filter(t=>!e||t.equipment_code.toLowerCase().includes(e)).filter(e=>"all"===O||x(e).color.toLowerCase()===O).sort((e,t)=>{if("closed"===L){let l=e.closed_at?new Date(e.closed_at).getTime():0;return(t.closed_at?new Date(t.closed_at).getTime():0)-l}return u(e.outage_date).getTime()-u(t.outage_date).getTime()})},[t,C,O,L]);return(0,a.jsx)("div",{className:_.We,children:(0,a.jsxs)("div",{className:"mx-auto flex w-full max-w-5xl flex-col gap-6 px-4 py-8 sm:px-6 lg:px-8",children:[(0,a.jsxs)("header",{className:"flex flex-col gap-5 rounded-2xl border border-slate-200/60 bg-white/80 p-6 shadow-sm",children:[(0,a.jsxs)("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-semibold tracking-tight text-slate-900",children:"Krabi Outage Tracker"}),(0,a.jsx)("p",{className:"text-sm text-slate-500",children:"ติดตามงานดับไฟตามกำหนดและสถานะวันคงเหลือ"})]}),(0,a.jsxs)("div",{className:"flex flex-col items-start gap-3 sm:items-end",children:[ep?(0,a.jsx)("span",{className:"text-xs font-medium text-slate-500",children:ep}):null,(0,a.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,a.jsx)(s.default,{href:"/new",className:_.MY,children:"+ สร้างงาน"}),(0,a.jsx)("button",{type:"button",onClick:ew,className:_.SK,children:"ออกจากระบบ"})]})]})]}),(0,a.jsxs)("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between",children:[(0,a.jsxs)("div",{className:"flex w-full max-w-md flex-col gap-2",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-slate-600",children:"ค้นหาอุปกรณ์"}),(0,a.jsx)("input",{value:C,onChange:e=>D(e.target.value),placeholder:"กรอกรหัสอุปกรณ์",className:_.cX})]}),(0,a.jsx)(c,{options:[{id:"all",label:"ทั้งหมด"},{id:"green",label:"เขียว"},{id:"yellow",label:"เหลือง"},{id:"red",label:"แดง"}],value:O,onChange:T})]}),(0,a.jsx)(c,{options:[{id:"active",label:"กำลังดำเนินการ"},{id:"closed",label:"ปิดแล้ว"}],value:L,onChange:P})]}),em?(0,a.jsx)("div",{className:"rounded-xl border px-4 py-3 text-sm ".concat("success"===em.tone?"border-emerald-200 bg-emerald-50 text-emerald-700":"border-rose-200 bg-rose-50 text-rose-700"),children:em.message}):null,f?(0,a.jsx)("div",{className:"rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700",children:f}):null,I?(0,a.jsx)("div",{className:"rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700",children:I}):null,(0,a.jsx)("section",{className:"grid gap-4",children:m?(0,a.jsx)("div",{className:"".concat(_.pU," px-4 py-8 text-center text-sm text-slate-500"),children:"กำลังโหลดข้อมูล..."}):0===eC.length?(0,a.jsx)("div",{className:"".concat(_.pU," px-4 py-8 text-center text-sm text-slate-500"),children:"ยังไม่มีงานที่ตรงกับตัวกรอง"}):eC.map(e=>{var t,l,n,o,r,d,c,m,p,f;let h=x(e),v="RED"===(f=h.color)?{strip:"bg-rose-200/80",badge:"border border-rose-200/80 bg-rose-50 text-rose-700",text:"text-rose-700"}:"YELLOW"===f?{strip:"bg-amber-200/80",badge:"border border-amber-200/80 bg-amber-50 text-amber-700",text:"text-amber-700"}:{strip:"bg-emerald-200/80",badge:"border border-emerald-200/80 bg-emerald-50 text-emerald-700",text:"text-emerald-700"},g=null!==(l=e.nakhon_status)&&void 0!==l?l:"PENDING",j="NOTIFIED"===g,w=null!==(n=U[e.id])&&void 0!==n&&n,C=null!==(o=e.is_closed)&&void 0!==o&&o,D="GENERATED"===e.doc_status||!!e.doc_generated_at,O="GENERATING"===e.doc_status,T=null!==(r=e.social_status)&&void 0!==r?r:"DRAFT",L=null!==(d=e.notice_status)&&void 0!==d?d:"NONE",P=N(e),I=y[P],R=e=>e===P?k:E;return(0,a.jsxs)("div",{className:"".concat(_.pU," group flex items-stretch overflow-hidden transition hover:-translate-y-0.5"),children:[(0,a.jsx)("div",{className:"w-2 ".concat(v.strip)}),(0,a.jsxs)("div",{className:"flex w-full flex-col gap-4 p-5 sm:flex-row sm:items-start sm:justify-between",children:[(0,a.jsxs)(s.default,{href:"/job/".concat(e.id),className:"flex min-w-[240px] flex-1 flex-col gap-4",children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-start justify-between gap-3",children:[(0,a.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,a.jsx)("span",{className:"text-sm text-slate-500",children:u(e.outage_date).toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"})}),(0,a.jsx)("span",{className:"text-sm font-medium ".concat(v.text),children:h.label})]}),(0,a.jsx)(b,{status:h.color,label:h.color})]}),C?(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-2 text-xs font-medium text-slate-600",children:[(0,a.jsx)("span",{className:"rounded-full bg-slate-100 px-3 py-1 text-slate-700",children:"ปิดแล้ว"}),(0,a.jsxs)("span",{children:["ปิดเมื่อ"," ",e.closed_at?new Date(e.closed_at).toLocaleString("th-TH",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-"]})]}):null,(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("p",{className:"text-lg font-semibold tracking-tight text-slate-900",children:e.equipment_code}),(0,a.jsx)("p",{className:"text-sm text-slate-600",children:(null===(t=e.note)||void 0===t?void 0:t.trim())||"ไม่มีหมายเหตุ"})]}),(0,a.jsxs)("div",{className:"grid gap-3 text-xs text-slate-500 sm:grid-cols-2",children:[(0,a.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,a.jsx)("span",{children:"ลิ้ง Google Map"}),(0,a.jsx)(i.Z,{url:null!==(c=e.map_link)&&void 0!==c?c:void 0,label:"เปิด Google Map"})]}),(0,a.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,a.jsx)("span",{children:"ลิ้ง My Map"}),(0,a.jsx)(i.Z,{url:null!==(m=e.mymaps_url)&&void 0!==m?m:void 0})]})]}),(j||"NOT_REQUIRED"===g)&&(0,a.jsx)("div",{className:"text-sm text-slate-600",children:j?(0,a.jsxs)(a.Fragment,{children:["แจ้งศูนย์นครแล้ว:"," ",(0,a.jsx)("span",{className:"font-medium text-slate-800",children:e.nakhon_notified_date?u(e.nakhon_notified_date).toLocaleDateString("th-TH",{year:"numeric",month:"short",day:"numeric"}):"-"})," ","| เลขที่บันทึก:"," ",(0,a.jsx)("span",{className:"font-medium text-slate-800",children:null!==(p=e.nakhon_memo_no)&&void 0!==p?p:"-"})]}):(0,a.jsx)("span",{children:"ไม่ต้องแจ้งศูนย์นคร"})})]}),C?null:(0,a.jsxs)("div",{className:"flex w-full flex-col items-stretch gap-2 sm:w-auto sm:min-w-[220px]",children:[(0,a.jsxs)("div",{className:"text-xs font-medium text-slate-500",children:["ขั้นตอนถัดไป:"," ",(0,a.jsx)("span",{className:"text-slate-700",children:I})]}),"PENDING"===g?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{type:"button",onClick:()=>eg(e),className:R("notify_nakhon"),children:"แจ้งศูนย์นครแล้ว"}),(0,a.jsx)("button",{type:"button",onClick:()=>eE(e),disabled:w,className:"".concat(E," ").concat(S),children:w?"กำลังบันทึก...":"ไม่ต้องแจ้งศูนย์นคร"})]}):(0,a.jsx)(a.Fragment,{children:D?e.doc_url?(0,a.jsx)("button",{type:"button",onClick:()=>{if(e.doc_url){window.open(e.doc_url,"_blank","noopener,noreferrer");return}ej(e)},className:R("create_doc"),children:"พิมพ์เอกสาร"}):(0,a.jsx)("button",{type:"button",onClick:()=>ej(e),className:E,children:"ดาวน์โหลดเอกสารอีกครั้ง"}):(0,a.jsx)("button",{type:"button",onClick:()=>ej(e),disabled:w||O,className:"".concat(R("create_doc")," ").concat(S),children:O?"กำลังสร้าง...":"สร้างเอกสารดับไฟ"})}),"PENDING_APPROVAL"===T||"POSTED"===T?(0,a.jsx)("button",{type:"button",onClick:()=>V(e),className:R("wait_approval"),children:"POSTED"===T?"Posted แล้วสื่อ Social":"รออนุมัติ"}):null,"POSTED"===T?(0,a.jsx)("button",{type:"button",onClick:()=>$(e),className:R("notify_outage_letter"),children:"SCHEDULED"===L?"กำหนดการแจ้งเรียบร้อยแล้ว (แก้ไขได้)":"แจ้งหนังสือดับไฟ"}):null,"SCHEDULED"!==L||C?null:(0,a.jsx)("button",{type:"button",onClick:()=>eN(e),className:R("close_job"),children:"ปิดงาน"})]})]})]},e.id)})}),(0,a.jsx)(r.Z,{isOpen:!!A,title:"แจ้งศูนย์นครแล้ว",onClose:e_,children:(0,a.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["วันที่แจ้งศูนย์นคร",(0,a.jsx)("input",{type:"date",value:M,onChange:e=>F(e.target.value),className:_.cX,required:!0}),Y.date?(0,a.jsx)("span",{className:"text-xs text-red-600",children:Y.date}):null]}),(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["เลขที่บันทึก",(0,a.jsx)("input",{type:"text",value:Z,onChange:e=>X(e.target.value),className:_.cX,required:!0}),Y.memoNo?(0,a.jsx)("span",{className:"text-xs text-red-600",children:Y.memoNo}):null]}),Y.submit?(0,a.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:Y.submit}):null,(0,a.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[(0,a.jsx)("button",{type:"button",onClick:e_,className:_.SK,children:"ยกเลิก"}),(0,a.jsx)("button",{type:"button",onClick:ek,disabled:H,className:"".concat(_.MY," disabled:cursor-not-allowed disabled:opacity-70"),children:H?"กำลังบันทึก...":"ตกลง"})]})]})}),(0,a.jsx)(r.Z,{isOpen:!!J,title:"สร้างเอกสารดับไฟ",onClose:eb,children:(0,a.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["หนังสือลงวันที่",(0,a.jsx)("input",{type:"date",value:ee.doc_issue_date,onChange:e=>et(t=>({...t,doc_issue_date:e.target.value})),className:_.cX,required:!0}),el.doc_issue_date?(0,a.jsx)("span",{className:"text-xs text-red-600",children:el.doc_issue_date}):null]}),(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["ดับไฟเพื่อ",(0,a.jsx)("input",{type:"text",value:ee.doc_purpose,onChange:e=>et(t=>({...t,doc_purpose:e.target.value})),className:_.cX,required:!0}),el.doc_purpose?(0,a.jsx)("span",{className:"text-xs text-red-600",children:el.doc_purpose}):null]}),(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["บริเวณที่ดับ",(0,a.jsx)("input",{type:"text",value:ee.doc_area_title,onChange:e=>et(t=>({...t,doc_area_title:e.target.value})),className:_.cX,required:!0}),el.doc_area_title?(0,a.jsx)("span",{className:"text-xs text-red-600",children:el.doc_area_title}):null]}),(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["เวลาเริ่มดับไฟ",(0,a.jsx)("input",{type:"time",value:ee.doc_time_start,onChange:e=>et(t=>({...t,doc_time_start:e.target.value})),className:_.cX,required:!0}),el.doc_time_start?(0,a.jsx)("span",{className:"text-xs text-red-600",children:el.doc_time_start}):null]}),(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["เวลาจ่ายไฟ",(0,a.jsx)("input",{type:"time",value:ee.doc_time_end,onChange:e=>et(t=>({...t,doc_time_end:e.target.value})),className:_.cX,required:!0}),el.doc_time_end?(0,a.jsx)("span",{className:"text-xs text-red-600",children:el.doc_time_end}):null]}),(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["รายละเอียดพื้นที่ดับไฟ",(0,a.jsx)("textarea",{value:ee.doc_area_detail,onChange:e=>et(t=>({...t,doc_area_detail:e.target.value})),rows:3,className:_.cX,required:!0}),el.doc_area_detail?(0,a.jsx)("span",{className:"text-xs text-red-600",children:el.doc_area_detail}):null]}),(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["ลิ้ง google map",(0,a.jsx)("input",{type:"url",value:ee.map_link,onChange:e=>et(t=>({...t,map_link:e.target.value})),className:_.cX,required:!0}),el.map_link?(0,a.jsx)("span",{className:"text-xs text-red-600",children:el.map_link}):null]}),el.submit?(0,a.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:el.submit}):null,(0,a.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[(0,a.jsx)("button",{type:"button",onClick:eb,className:_.SK,children:"ยกเลิก"}),(0,a.jsx)("button",{type:"button",onClick:eS,disabled:es,className:"".concat(_.MY," disabled:cursor-not-allowed disabled:opacity-70"),children:es?"กำลังสร้าง...":"สร้าง"})]})]})}),(0,a.jsx)(h,{job:Q,isOpen:!!Q,onClose:()=>{V(null)},onJobUpdate:(e,t)=>{l(l=>l.map(l=>l.id===e?{...l,...t}:l)),V(l=>(null==l?void 0:l.id)===e?{...l,...t}:l)}}),(0,a.jsx)(d.Z,{job:z,open:!!z,onOpenChange:e=>{e||ev()},onJobUpdate:(e,t)=>{l(l=>l.map(l=>l.id===e?{...l,...t}:l)),$(l=>(null==l?void 0:l.id)===e?{...l,...t}:l)}}),(0,a.jsx)(r.Z,{isOpen:!!eo,title:"ยืนยันปิดงาน?",onClose:()=>ei(null),children:(0,a.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,a.jsx)("p",{className:"text-sm text-slate-600",children:'ปิดงานแล้วจะถูกย้ายไปที่ "งานที่ปิดแล้ว" และไม่สามารถแก้ไขได้'}),ec?(0,a.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:ec}):null,(0,a.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[(0,a.jsx)("button",{type:"button",onClick:()=>ei(null),className:_.SK,children:"ยกเลิก"}),(0,a.jsx)("button",{type:"button",onClick:ey,disabled:er,className:"".concat(_.MY," disabled:cursor-not-allowed disabled:opacity-70"),children:er?"กำลังปิดงาน...":"ยืนยันปิดงาน"})]})]})})]})})}},4347:function(e,t,l){l.d(t,{Z:function(){return o}});var a=l(7437),s=l(836);let n=e=>{let t=null==e?void 0:e.trim();if(!t)return{status:"empty"};let l=/^https?:\/\//i.test(t)?t:"https://".concat(t);try{let e=new URL(l);if("http:"!==e.protocol&&"https:"!==e.protocol)return{status:"invalid"};return{status:"valid",url:e.toString()}}catch(e){return{status:"invalid"}}};function o(e){let{url:t,label:l="เปิด My Map",className:o=""}=e,i=n(t),r=o?" ".concat(o):"";if("valid"===i.status)return(0,a.jsx)("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center ".concat(s.hV).concat(r),children:l});let d="empty"===i.status?"ไม่มีลิงก์แผนที่":"ลิงก์ไม่ถูกต้อง";return(0,a.jsx)("span",{className:"text-sm text-slate-400".concat(r),children:d})}},9320:function(e,t,l){l.d(t,{Z:function(){return s}});var a=l(7437);function s(e){let{isOpen:t,title:l,onClose:s,children:n}=e;return t?(0,a.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center px-4",children:[(0,a.jsx)("div",{className:"absolute inset-0 bg-slate-900/40",onClick:s,role:"presentation"}),(0,a.jsxs)("div",{className:"relative z-10 w-full max-w-lg rounded-xl bg-white p-6 shadow-xl",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[l?(0,a.jsx)("h2",{className:"text-lg font-semibold text-slate-900",children:l}):null,(0,a.jsx)("button",{type:"button",onClick:s,className:"text-sm text-slate-500 hover:text-slate-700",children:"ปิด"})]}),(0,a.jsx)("div",{className:"mt-4",children:n})]})]}):null}},3442:function(e,t,l){l.d(t,{Z:function(){return o}});var a=l(7437),s=l(2265),n=l(9320);function o(e){let{open:t,onOpenChange:l,job:o,onJobUpdate:i}=e,[r,d]=(0,s.useState)(""),[c,u]=(0,s.useState)(""),[m,x]=(0,s.useState)(""),[p,f]=(0,s.useState)({}),[h,_]=(0,s.useState)(!1),[b,v]=(0,s.useState)(null);(0,s.useEffect)(()=>{var e,l,a;t&&(d(null!==(e=null==o?void 0:o.notice_date)&&void 0!==e?e:""),u(null!==(l=null==o?void 0:o.notice_by)&&void 0!==l?l:""),x(null!==(a=null==o?void 0:o.mymaps_url)&&void 0!==a?a:""),f({}),v(null),_(!1))},[t,o]),(0,s.useEffect)(()=>{if(!b)return;let e=window.setTimeout(()=>{v(null)},2e3);return()=>window.clearTimeout(e)},[b]);let g=async()=>{if(!o)return;let e={},t=m.trim();if(r||(e.noticeDate="กรุณาระบุวันที่จะไปดำเนินการแจ้ง"),c.trim()||(e.noticeBy="กรุณาระบุผู้แจ้ง"),t){let l=/^https?:\/\//i.test(t)?t:"https://".concat(t);try{let e=new URL(l);if("http:"!==e.protocol&&"https:"!==e.protocol)throw Error("invalid protocol")}catch(t){e.mymapsUrl="ลิ้งไม่ถูกต้อง"}}else e.mymapsUrl="กรุณาระบุลิ้ง my map";if(Object.keys(e).length>0){f(e);return}_(!0),f({});try{var a,s;let e=/^https?:\/\//i.test(t)?t:"https://".concat(t),n={jobId:o.id,notice_date:r,notice_by:c.trim(),mymaps_url:e},d=await fetch("/api/jobs/notice-schedule",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),u=await d.json().catch(()=>null);if(!d.ok||!(null==u?void 0:u.ok))throw Error(null!==(a=null==u?void 0:u.error)&&void 0!==a?a:"ไม่สามารถบันทึกกำหนดการได้");let m=null!==(s=u.notice_scheduled_at)&&void 0!==s?s:new Date().toISOString();null==i||i(o.id,{notice_status:"SCHEDULED",notice_date:n.notice_date,notice_by:n.notice_by,mymaps_url:n.mymaps_url,notice_scheduled_at:m}),v("กำหนดการแจ้งเรียบร้อยแล้ว"),setTimeout(()=>{l(!1)},800)}catch(e){console.error("Notice schedule failed",e),f({submit:"บันทึกกำหนดการไม่สำเร็จ กรุณาลองใหม่"})}finally{_(!1)}};return(0,a.jsx)(n.Z,{isOpen:t,title:"แจ้งหนังสือดับไฟ",onClose:()=>l(!1),children:(0,a.jsxs)("div",{className:"flex flex-col gap-4",children:[b?(0,a.jsx)("div",{className:"rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-2 text-sm text-emerald-700",children:b}):null,(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["วันที่จะไปดำเนินการแจ้ง",(0,a.jsx)("input",{type:"date",value:r,onChange:e=>d(e.target.value),className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0}),p.noticeDate?(0,a.jsx)("span",{className:"text-xs text-red-600",children:p.noticeDate}):null]}),(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["ผู้แจ้ง",(0,a.jsx)("input",{type:"text",value:c,onChange:e=>u(e.target.value),className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0}),p.noticeBy?(0,a.jsx)("span",{className:"text-xs text-red-600",children:p.noticeBy}):null]}),(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["ลิ้ง my map",(0,a.jsx)("input",{type:"url",value:m,onChange:e=>x(e.target.value),placeholder:"https://",className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0}),p.mymapsUrl?(0,a.jsx)("span",{className:"text-xs text-red-600",children:p.mymapsUrl}):null]}),p.submit?(0,a.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:p.submit}):null,(0,a.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[(0,a.jsx)("button",{type:"button",onClick:()=>l(!1),className:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"ยกเลิก"}),(0,a.jsx)("button",{type:"button",onClick:g,disabled:h,className:"rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70",children:h?"กำลังบันทึก...":"บันทึกกำหนดการ"})]})]})})}},1707:function(e,t,l){l.d(t,{Cq:function(){return o},DQ:function(){return s},Z6:function(){return r},Zn:function(){return n},gK:function(){return i},uA:function(){return d}});var a=l(3866);async function s(){return a.O.from("outage_jobs").select("*").order("outage_date",{ascending:!0})}async function n(e){return a.O.from("outage_jobs").select("*").eq("id",e).single()}async function o(e){var t;return a.O.from("outage_jobs").insert({outage_date:e.outage_date,equipment_code:e.equipment_code,note:null!==(t=e.note)&&void 0!==t?t:null})}async function i(e,t){var l;return a.O.from("outage_jobs").update({outage_date:t.outage_date,equipment_code:t.equipment_code,note:null!==(l=t.note)&&void 0!==l?l:null}).eq("id",e)}async function r(e,t){return a.O.from("outage_jobs").update({nakhon_status:"NOTIFIED",nakhon_notified_date:t.date,nakhon_memo_no:t.memoNo}).eq("id",e)}async function d(e){return a.O.from("outage_jobs").update({nakhon_status:"NOT_REQUIRED",nakhon_notified_date:null,nakhon_memo_no:null}).eq("id",e)}},3866:function(e,t,l){l.d(t,{O:function(){return a}});let a=(0,l(2157).e)()},2157:function(e,t,l){l.d(t,{X:function(){return u},e:function(){return c}});var a=l(7327);l(357);let s="https://yhkrzepnokhiqbxwhkgz.supabase.co",n="sb_publishable_CdTtNwP3k39LxhkLkKbS3w_Y3co_tFE",o=null,i=!1,r=()=>{if(!s||!n)throw Error("Missing Supabase env vars. Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY.")},d=async(e,t)=>{e&&t?await fetch("/api/auth/session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessToken:e,refreshToken:t})}):await fetch("/api/auth/session",{method:"DELETE"})},c=()=>(r(),o||(o=(0,a.eI)(s,n)),i||(i=!0,o.auth.onAuthStateChange((e,t)=>{var l,a;d(null!==(l=null==t?void 0:t.access_token)&&void 0!==l?l:null,null!==(a=null==t?void 0:t.refresh_token)&&void 0!==a?a:null)})),o),u=async e=>{await d(e.access_token,e.refresh_token)}},836:function(e,t,l){l.d(t,{MY:function(){return o},SK:function(){return i},We:function(){return a},cS:function(){return c},cX:function(){return r},hV:function(){return d},pU:function(){return s},uI:function(){return n}});let a="min-h-screen bg-slate-50",s="rounded-2xl border border-slate-200/60 bg-white/80 shadow-sm transition hover:shadow-md",n="bg-violet-600 text-white hover:bg-violet-700 focus-visible:ring-violet-300",o="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-medium shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 ".concat(n),i="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-slate-100/60 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-violet-300 focus-visible:ring-offset-2",r="rounded-xl border border-slate-200/80 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm outline-none transition focus:border-violet-500 focus-visible:ring-2 focus-visible:ring-violet-200",d="text-sm font-medium text-violet-600 underline-offset-4 transition hover:text-violet-700 hover:underline",c=e=>{switch(e){case"RED":return"border border-rose-200/80 bg-rose-50 text-rose-700";case"YELLOW":return"border border-amber-200/80 bg-amber-50 text-amber-700";default:return"border border-emerald-200/80 bg-emerald-50 text-emerald-700"}}}}]);