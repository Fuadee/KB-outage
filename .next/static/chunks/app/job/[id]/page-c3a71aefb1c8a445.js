(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[534],{8038:function(e,l,s){Promise.resolve().then(s.bind(s,7350))},7350:function(e,l,s){"use strict";s.r(l),s.d(l,{default:function(){return j}});var t=s(7437),a=s(2265),n=s(6463),r=s(7138),i=s(6600),d=s(3442),o=s(9320),c=s(649),u=s(6760),x=s(4608),m=s(9155),h=s(1707),f=s(3866);function j(){var e,l,s,j;let p=(0,n.useRouter)(),v=(0,n.useParams)(),[b,g]=(0,a.useState)(""),[y,N]=(0,a.useState)(""),[w,S]=(0,a.useState)(""),[_,Z]=(0,a.useState)(!0),[E,C]=(0,a.useState)(!1),[k,O]=(0,a.useState)(null),[D,T]=(0,a.useState)(null),[U,L]=(0,a.useState)(!1),[P,q]=(0,a.useState)(!1),[H,Y]=(0,a.useState)(!1),[z,J]=(0,a.useState)(null),[A,F]=(0,a.useState)(null);(0,a.useEffect)(()=>{(async()=>{var e,l;if(!v.id)return;Z(!0),O(null);let{data:s,error:t}=await (0,h.Zn)(v.id);if(t||!s){O(null!==(e=null==t?void 0:t.message)&&void 0!==e?e:"ไม่พบงานที่ต้องการ"),Z(!1);return}T(s),g(s.outage_date),N(s.equipment_code),S(null!==(l=s.note)&&void 0!==l?l:""),Z(!1)})()},[v.id]),(0,a.useEffect)(()=>{if(!A)return;let e=window.setTimeout(()=>{F(null)},2e3);return()=>window.clearTimeout(e)},[A]);let I=async e=>{if(e.preventDefault(),!v.id||(null==D?void 0:D.is_closed))return;if(O(null),!b||!y.trim()){O("กรุณากรอกวันที่และรหัสอุปกรณ์");return}C(!0);let{error:l}=await (0,h.gK)(v.id,{outage_date:b,equipment_code:y.trim(),note:w.trim()?w.trim():null});if(l){O(l.message),C(!1);return}C(!1),p.push("/")},K=async()=>{if(v.id&&(null==D||!D.is_closed)){C(!0),O(null);try{let l=await fetch("/api/jobs/".concat(v.id,"/delete"),{method:"DELETE"}),s=await l.json().catch(()=>null);if(!l.ok||!(null==s?void 0:s.ok)||0===s.deletedCount){var e;let l=null!==(e=null==s?void 0:s.error)&&void 0!==e?e:"ลบไม่สำเร็จ (สิทธิไม่อนุญาตหรือไม่พบรายการ)";O(l),F({message:l,tone:"error"}),C(!1);return}p.push("/")}catch(l){let e=l instanceof Error?l.message:"ลบไม่สำเร็จ (สิทธิไม่อนุญาตหรือไม่พบรายการ)";O(e),F({message:e,tone:"error"})}finally{C(!1)}}},M=e=>{T(l=>l?{...l,...e}:l)},R=async()=>{if(!D)return;Y(!0),J(null);let{data:e}=await f.O.auth.getSession();if(!e.session){Y(!1),q(!1),p.push("/login");return}try{let e=await fetch("/api/jobs/".concat(D.id,"/close"),{method:"POST",headers:{"Content-Type":"application/json"}});if(401===e.status){Y(!1),q(!1),p.push("/login");return}let s=await e.json().catch(()=>null);if(!e.ok||!(null==s?void 0:s.ok)){var l;throw Error(null!==(l=null==s?void 0:s.error)&&void 0!==l?l:"ปิดงานไม่สำเร็จ กรุณาลองใหม่")}F({message:"✅ ปิดงานเรียบร้อย",tone:"success"}),T(e=>{var l;return e?{...e,is_closed:!0,closed_at:null!==(l=s.closed_at)&&void 0!==l?l:new Date().toISOString()}:e}),q(!1)}catch(l){let e=l instanceof Error?l.message:"ปิดงานไม่สำเร็จ กรุณาลองใหม่";J(e),F({message:e,tone:"error"})}finally{Y(!1)}};if(_)return(0,t.jsx)("div",{className:"rounded-2xl border border-slate-200 bg-white px-4 py-8 text-center text-sm text-slate-500 shadow-sm",children:"กำลังโหลดข้อมูล..."});let B=null!==(e=null==D?void 0:D.is_closed)&&void 0!==e&&e,G=(null!==(l=null==D?void 0:D.notice_status)&&void 0!==l?l:"NONE")==="SCHEDULED"&&!B;return(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("header",{className:"space-y-3",children:[(0,t.jsx)("p",{className:"text-xs font-semibold uppercase tracking-[0.3em] text-slate-400",children:"Job detail"}),(0,t.jsxs)("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("h1",{className:"text-2xl font-semibold tracking-tight text-slate-900",children:B?"รายละเอียดงาน":"แก้ไขงาน"}),(0,t.jsx)("p",{className:"text-sm text-slate-600",children:B?"งานนี้ถูกปิดแล้วและไม่สามารถแก้ไขได้":"ปรับปรุงรายละเอียดหรือลบงานนี้ออกจากระบบ"}),B?(0,t.jsxs)("div",{className:"text-sm text-slate-600",children:["ปิดเมื่อ"," ",(0,t.jsx)("span",{className:"font-medium text-slate-800",children:(null==D?void 0:D.closed_at)?new Date(D.closed_at).toLocaleString("th-TH",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-"})]}):null]}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(null==D?void 0:D.social_status)!=="POSTED"||B?null:(0,t.jsx)(u.Z,{type:"button",variant:"secondary",size:"sm",onClick:()=>L(!0),children:(null!==(s=D.notice_status)&&void 0!==s?s:"NONE")==="SCHEDULED"?"กำหนดการแจ้งเรียบร้อยแล้ว (แก้ไขได้)":"แจ้งหนังสือดับไฟ"}),G?(0,t.jsx)(u.Z,{type:"button",size:"sm",onClick:()=>{J(null),q(!0)},children:"ปิดงาน"}):null,(0,t.jsx)(c.Z,{variant:B?"neutral":"accent",children:B?"Closed":"Active"})]})]}),A?(0,t.jsx)(x.Zb,{className:"".concat("success"===A.tone?"border-emerald-200 bg-emerald-50/80":"border-rose-200 bg-rose-50/80"),children:(0,t.jsx)(x.aY,{className:"py-3 text-sm ".concat("success"===A.tone?"text-emerald-700":"text-rose-700"),children:A.message})}):null]}),(0,t.jsxs)("div",{className:"grid gap-6 lg:grid-cols-[minmax(0,1fr)_320px]",children:[(0,t.jsxs)(x.Zb,{children:[(0,t.jsxs)(x.Ol,{children:[(0,t.jsx)(x.ll,{children:"รายละเอียดงาน"}),(0,t.jsx)(x.SZ,{children:"ข้อมูลพื้นฐานและหมายเหตุเพิ่มเติม"})]}),(0,t.jsx)(x.aY,{children:(0,t.jsxs)("form",{onSubmit:I,className:"flex flex-col gap-6",children:[(0,t.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["วันที่ดับไฟ",(0,t.jsx)(m.Z,{type:"date",value:b,onChange:e=>g(e.target.value),disabled:B,required:!0})]}),(0,t.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["รหัสอุปกรณ์",(0,t.jsx)(m.Z,{type:"text",value:y,onChange:e=>N(e.target.value),disabled:B,required:!0})]}),(0,t.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["หมายเหตุเพิ่มเติม",(0,t.jsx)("textarea",{value:w,onChange:e=>S(e.target.value),rows:4,disabled:B,className:"w-full rounded-xl border border-slate-200/80 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm transition focus:border-fuchsia-400 focus:outline-none focus:ring-2 focus:ring-fuchsia-200"})]}),k?(0,t.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:k}):null,(0,t.jsxs)("div",{className:"flex flex-wrap gap-3",children:[B?null:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(u.Z,{type:"submit",disabled:E,children:E?"กำลังบันทึก...":"บันทึก"}),(0,t.jsx)(u.Z,{type:"button",variant:"secondary",disabled:E,onClick:K,className:"border-rose-200 text-rose-600 hover:bg-rose-50",children:"ลบงาน"})]}),(0,t.jsx)(r.default,{href:"/",className:"inline-flex items-center justify-center rounded-full border border-slate-200 px-5 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"กลับ"})]})]})})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)(x.Zb,{children:[(0,t.jsxs)(x.Ol,{children:[(0,t.jsx)(x.ll,{children:"ลิงก์แผนที่"}),(0,t.jsx)(x.SZ,{children:"เข้าถึงแผนที่และจุดงาน"})]}),(0,t.jsx)(x.aY,{children:(0,t.jsx)(i.Z,{googleUrl:null==D?void 0:D.map_link,myMapUrl:null==D?void 0:D.mymaps_url,className:"mt-3"})})]}),(0,t.jsxs)(x.Zb,{children:[(0,t.jsxs)(x.Ol,{children:[(0,t.jsx)(x.ll,{children:"การดำเนินการ"}),(0,t.jsx)(x.SZ,{children:"งานที่เกี่ยวข้องกับสถานะนี้"})]}),(0,t.jsxs)(x.aY,{className:"space-y-3",children:[(null==D?void 0:D.social_status)!=="POSTED"||B?(0,t.jsx)(c.Z,{variant:"default",children:"รอการโพสต์ Social"}):(0,t.jsx)(u.Z,{type:"button",variant:"secondary",className:"w-full",onClick:()=>L(!0),children:(null!==(j=D.notice_status)&&void 0!==j?j:"NONE")==="SCHEDULED"?"กำหนดการแจ้งเรียบร้อยแล้ว (แก้ไขได้)":"แจ้งหนังสือดับไฟ"}),G?(0,t.jsx)(u.Z,{type:"button",className:"w-full",onClick:()=>{J(null),q(!0)},children:"ปิดงาน"}):(0,t.jsx)(c.Z,{variant:"neutral",children:"ยังไม่พร้อมปิดงาน"})]})]})]})]}),(0,t.jsx)(d.Z,{job:D,open:U,onOpenChange:L,onJobUpdate:(e,l)=>M(l)}),(0,t.jsx)(o.Z,{isOpen:P,title:"ยืนยันปิดงาน?",onClose:()=>q(!1),children:(0,t.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,t.jsx)("p",{className:"text-sm text-slate-600",children:'ปิดงานแล้วจะถูกย้ายไปที่ "งานที่ปิดแล้ว" และไม่สามารถแก้ไขได้'}),z?(0,t.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:z}):null,(0,t.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[(0,t.jsx)(u.Z,{type:"button",variant:"secondary",onClick:()=>q(!1),children:"ยกเลิก"}),(0,t.jsx)(u.Z,{type:"button",onClick:R,disabled:H,children:H?"กำลังปิดงาน...":"ยืนยันปิดงาน"})]})]})})]})}}},function(e){e.O(0,[138,200,877,971,23,744],function(){return e(e.s=8038)}),_N_E=e.O()}]);