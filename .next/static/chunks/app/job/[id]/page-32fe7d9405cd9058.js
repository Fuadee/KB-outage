(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[534],{8038:function(e,t,s){Promise.resolve().then(s.bind(s,7350))},7350:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return m}});var n=s(7437),l=s(2265),r=s(6463),o=s(7138),a=s(4347),i=s(3442),d=s(9320),u=s(1707),c=s(3866);function m(){var e,t,s,m,x;let f=(0,r.useRouter)(),h=(0,r.useParams)(),[p,b]=(0,l.useState)(""),[v,g]=(0,l.useState)(""),[y,j]=(0,l.useState)(""),[w,_]=(0,l.useState)(!0),[N,S]=(0,l.useState)(!1),[E,k]=(0,l.useState)(null),[C,O]=(0,l.useState)(null),[D,T]=(0,l.useState)(!1),[q,U]=(0,l.useState)(!1),[L,P]=(0,l.useState)(!1),[Z,I]=(0,l.useState)(null),[M,A]=(0,l.useState)(null);(0,l.useEffect)(()=>{(async()=>{var e,t;if(!h.id)return;_(!0),k(null);let{data:s,error:n}=await (0,u.Zn)(h.id);if(n||!s){k(null!==(e=null==n?void 0:n.message)&&void 0!==e?e:"ไม่พบงานที่ต้องการ"),_(!1);return}O(s),b(s.outage_date),g(s.equipment_code),j(null!==(t=s.note)&&void 0!==t?t:""),_(!1)})()},[h.id]),(0,l.useEffect)(()=>{if(!M)return;let e=window.setTimeout(()=>{A(null)},2e3);return()=>window.clearTimeout(e)},[M]);let B=async e=>{if(e.preventDefault(),!h.id||(null==C?void 0:C.is_closed))return;if(k(null),!p||!v.trim()){k("กรุณากรอกวันที่และรหัสอุปกรณ์");return}S(!0);let{error:t}=await (0,u.gK)(h.id,{outage_date:p,equipment_code:v.trim(),note:y.trim()?y.trim():null});if(t){k(t.message),S(!1);return}S(!1),f.push("/")},R=async()=>{if(h.id&&(null==C||!C.is_closed)){S(!0),k(null);try{let t=await fetch("/api/jobs/".concat(h.id,"/delete"),{method:"DELETE"}),s=await t.json().catch(()=>null);if(!t.ok||!(null==s?void 0:s.ok)||0===s.deletedCount){var e;let t=null!==(e=null==s?void 0:s.error)&&void 0!==e?e:"ลบไม่สำเร็จ (สิทธิไม่อนุญาตหรือไม่พบรายการ)";k(t),A({message:t,tone:"error"}),S(!1);return}f.push("/")}catch(t){let e=t instanceof Error?t.message:"ลบไม่สำเร็จ (สิทธิไม่อนุญาตหรือไม่พบรายการ)";k(e),A({message:e,tone:"error"})}finally{S(!1)}}},K=e=>{O(t=>t?{...t,...e}:t)},z=async()=>{if(!C)return;P(!0),I(null);let{data:e}=await c.O.auth.getSession();if(!e.session){P(!1),U(!1),f.push("/login");return}try{let e=await fetch("/api/jobs/".concat(C.id,"/close"),{method:"POST",headers:{"Content-Type":"application/json"}});if(401===e.status){P(!1),U(!1),f.push("/login");return}let s=await e.json().catch(()=>null);if(!e.ok||!(null==s?void 0:s.ok)){var t;throw Error(null!==(t=null==s?void 0:s.error)&&void 0!==t?t:"ปิดงานไม่สำเร็จ กรุณาลองใหม่")}A({message:"✅ ปิดงานเรียบร้อย",tone:"success"}),O(e=>{var t;return e?{...e,is_closed:!0,closed_at:null!==(t=s.closed_at)&&void 0!==t?t:new Date().toISOString()}:e}),U(!1)}catch(t){let e=t instanceof Error?t.message:"ปิดงานไม่สำเร็จ กรุณาลองใหม่";I(e),A({message:e,tone:"error"})}finally{P(!1)}};if(w)return(0,n.jsx)("div",{className:"rounded-2xl border border-slate-200 bg-white px-4 py-8 text-center text-sm text-slate-500 shadow-sm",children:"กำลังโหลดข้อมูล..."});let H=null!==(e=null==C?void 0:C.is_closed)&&void 0!==e&&e,X=(null!==(t=null==C?void 0:C.notice_status)&&void 0!==t?t:"NONE")==="SCHEDULED"&&!H;return(0,n.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,n.jsxs)("header",{className:"flex flex-col gap-2",children:[(0,n.jsx)("h1",{className:"text-2xl font-semibold",children:H?"รายละเอียดงาน":"แก้ไขงาน"}),(0,n.jsx)("p",{className:"text-sm text-slate-500",children:H?"งานนี้ถูกปิดแล้วและไม่สามารถแก้ไขได้":"ปรับปรุงรายละเอียดหรือลบงานนี้ออกจากระบบ"}),M?(0,n.jsx)("div",{className:"mt-2 rounded-xl border px-4 py-3 text-sm ".concat("success"===M.tone?"border-emerald-200 bg-emerald-50 text-emerald-700":"border-red-200 bg-red-50 text-red-700"),children:M.message}):null,H?(0,n.jsxs)("div",{className:"mt-2 text-sm text-slate-600",children:["ปิดเมื่อ"," ",(0,n.jsx)("span",{className:"font-medium text-slate-800",children:(null==C?void 0:C.closed_at)?new Date(C.closed_at).toLocaleString("th-TH",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-"})]}):null,(0,n.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2",children:[(null==C?void 0:C.social_status)!=="POSTED"||H?null:(0,n.jsx)("button",{type:"button",onClick:()=>T(!0),className:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:(null!==(s=C.notice_status)&&void 0!==s?s:"NONE")==="SCHEDULED"?"กำหนดการแจ้งเรียบร้อยแล้ว (แก้ไขได้)":"แจ้งหนังสือดับไฟ"}),X?(0,n.jsx)("button",{type:"button",onClick:()=>{I(null),U(!0)},className:"rounded-xl bg-amber-500 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-amber-400",children:"ปิดงาน"}):null]})]}),(0,n.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm",children:[(0,n.jsx)("h2",{className:"text-sm font-semibold text-slate-700",children:"ลิงก์แผนที่"}),(0,n.jsxs)("div",{className:"mt-3 grid gap-3",children:[(0,n.jsxs)("div",{className:"flex flex-col gap-1 text-xs text-slate-500",children:[(0,n.jsx)("span",{children:"ลิ้ง Google Map"}),(0,n.jsx)(a.Z,{url:null!==(m=null==C?void 0:C.map_link)&&void 0!==m?m:void 0,label:"เปิด Google Map"})]}),(0,n.jsxs)("div",{className:"flex flex-col gap-1 text-xs text-slate-500",children:[(0,n.jsx)("span",{children:"ลิ้ง My Map"}),(0,n.jsx)(a.Z,{url:null!==(x=null==C?void 0:C.mymaps_url)&&void 0!==x?x:void 0})]})]})]}),(0,n.jsxs)("form",{onSubmit:B,className:"flex flex-col gap-6 rounded-2xl bg-white p-6 shadow-sm",children:[(0,n.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["วันที่ดับไฟ",(0,n.jsx)("input",{type:"date",value:p,onChange:e=>b(e.target.value),disabled:H,className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0})]}),(0,n.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["รหัสอุปกรณ์",(0,n.jsx)("input",{type:"text",value:v,onChange:e=>g(e.target.value),disabled:H,className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0})]}),(0,n.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["หมายเหตุเพิ่มเติม",(0,n.jsx)("textarea",{value:y,onChange:e=>j(e.target.value),rows:4,disabled:H,className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400"})]}),E?(0,n.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:E}):null,(0,n.jsxs)("div",{className:"flex flex-wrap gap-3",children:[H?null:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("button",{type:"submit",disabled:N,className:"rounded-xl bg-slate-900 px-5 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70",children:N?"กำลังบันทึก...":"บันทึก"}),(0,n.jsx)("button",{type:"button",onClick:R,disabled:N,className:"rounded-xl border border-red-200 px-5 py-2 text-sm font-medium text-red-600 shadow-sm transition hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-70",children:"ลบงาน"})]}),(0,n.jsx)(o.default,{href:"/",className:"rounded-xl border border-slate-200 px-5 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"กลับ"})]})]}),(0,n.jsx)(i.Z,{job:C,open:D,onOpenChange:T,onJobUpdate:(e,t)=>K(t)}),(0,n.jsx)(d.Z,{isOpen:q,title:"ยืนยันปิดงาน?",onClose:()=>U(!1),children:(0,n.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,n.jsx)("p",{className:"text-sm text-slate-600",children:'ปิดงานแล้วจะถูกย้ายไปที่ "งานที่ปิดแล้ว" และไม่สามารถแก้ไขได้'}),Z?(0,n.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:Z}):null,(0,n.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[(0,n.jsx)("button",{type:"button",onClick:()=>U(!1),className:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"ยกเลิก"}),(0,n.jsx)("button",{type:"button",onClick:z,disabled:L,className:"rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70",children:L?"กำลังปิดงาน...":"ยืนยันปิดงาน"})]})]})})]})}},4347:function(e,t,s){"use strict";s.d(t,{Z:function(){return o}});var n=s(7437),l=s(836);let r=e=>{let t=null==e?void 0:e.trim();if(!t)return{status:"empty"};let s=/^https?:\/\//i.test(t)?t:"https://".concat(t);try{let e=new URL(s);if("http:"!==e.protocol&&"https:"!==e.protocol)return{status:"invalid"};return{status:"valid",url:e.toString()}}catch(e){return{status:"invalid"}}};function o(e){let{url:t,label:s="เปิด My Map",className:o=""}=e,a=r(t),i=o?" ".concat(o):"";if("valid"===a.status)return(0,n.jsx)("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center ".concat(l.hV).concat(i),children:s});let d="empty"===a.status?"ไม่มีลิงก์แผนที่":"ลิงก์ไม่ถูกต้อง";return(0,n.jsx)("span",{className:"text-sm text-slate-400".concat(i),children:d})}},9320:function(e,t,s){"use strict";s.d(t,{Z:function(){return l}});var n=s(7437);function l(e){let{isOpen:t,title:s,onClose:l,children:r}=e;return t?(0,n.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center px-4",children:[(0,n.jsx)("div",{className:"absolute inset-0 bg-slate-900/40",onClick:l,role:"presentation"}),(0,n.jsxs)("div",{className:"relative z-10 w-full max-w-lg rounded-xl bg-white p-6 shadow-xl",children:[(0,n.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[s?(0,n.jsx)("h2",{className:"text-lg font-semibold text-slate-900",children:s}):null,(0,n.jsx)("button",{type:"button",onClick:l,className:"text-sm text-slate-500 hover:text-slate-700",children:"ปิด"})]}),(0,n.jsx)("div",{className:"mt-4",children:r})]})]}):null}},3442:function(e,t,s){"use strict";s.d(t,{Z:function(){return o}});var n=s(7437),l=s(2265),r=s(9320);function o(e){let{open:t,onOpenChange:s,job:o,onJobUpdate:a}=e,[i,d]=(0,l.useState)(""),[u,c]=(0,l.useState)(""),[m,x]=(0,l.useState)(""),[f,h]=(0,l.useState)({}),[p,b]=(0,l.useState)(!1),[v,g]=(0,l.useState)(null);(0,l.useEffect)(()=>{var e,s,n;t&&(d(null!==(e=null==o?void 0:o.notice_date)&&void 0!==e?e:""),c(null!==(s=null==o?void 0:o.notice_by)&&void 0!==s?s:""),x(null!==(n=null==o?void 0:o.mymaps_url)&&void 0!==n?n:""),h({}),g(null),b(!1))},[t,o]),(0,l.useEffect)(()=>{if(!v)return;let e=window.setTimeout(()=>{g(null)},2e3);return()=>window.clearTimeout(e)},[v]);let y=async()=>{if(!o)return;let e={},t=m.trim();if(i||(e.noticeDate="กรุณาระบุวันที่จะไปดำเนินการแจ้ง"),u.trim()||(e.noticeBy="กรุณาระบุผู้แจ้ง"),t){let s=/^https?:\/\//i.test(t)?t:"https://".concat(t);try{let e=new URL(s);if("http:"!==e.protocol&&"https:"!==e.protocol)throw Error("invalid protocol")}catch(t){e.mymapsUrl="ลิ้งไม่ถูกต้อง"}}else e.mymapsUrl="กรุณาระบุลิ้ง my map";if(Object.keys(e).length>0){h(e);return}b(!0),h({});try{var n,l;let e=/^https?:\/\//i.test(t)?t:"https://".concat(t),r={jobId:o.id,notice_date:i,notice_by:u.trim(),mymaps_url:e},d=await fetch("/api/jobs/notice-schedule",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),c=await d.json().catch(()=>null);if(!d.ok||!(null==c?void 0:c.ok))throw Error(null!==(n=null==c?void 0:c.error)&&void 0!==n?n:"ไม่สามารถบันทึกกำหนดการได้");let m=null!==(l=c.notice_scheduled_at)&&void 0!==l?l:new Date().toISOString();null==a||a(o.id,{notice_status:"SCHEDULED",notice_date:r.notice_date,notice_by:r.notice_by,mymaps_url:r.mymaps_url,notice_scheduled_at:m}),g("กำหนดการแจ้งเรียบร้อยแล้ว"),setTimeout(()=>{s(!1)},800)}catch(e){console.error("Notice schedule failed",e),h({submit:"บันทึกกำหนดการไม่สำเร็จ กรุณาลองใหม่"})}finally{b(!1)}};return(0,n.jsx)(r.Z,{isOpen:t,title:"แจ้งหนังสือดับไฟ",onClose:()=>s(!1),children:(0,n.jsxs)("div",{className:"flex flex-col gap-4",children:[v?(0,n.jsx)("div",{className:"rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-2 text-sm text-emerald-700",children:v}):null,(0,n.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["วันที่จะไปดำเนินการแจ้ง",(0,n.jsx)("input",{type:"date",value:i,onChange:e=>d(e.target.value),className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0}),f.noticeDate?(0,n.jsx)("span",{className:"text-xs text-red-600",children:f.noticeDate}):null]}),(0,n.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["ผู้แจ้ง",(0,n.jsx)("input",{type:"text",value:u,onChange:e=>c(e.target.value),className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0}),f.noticeBy?(0,n.jsx)("span",{className:"text-xs text-red-600",children:f.noticeBy}):null]}),(0,n.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["ลิ้ง my map",(0,n.jsx)("input",{type:"url",value:m,onChange:e=>x(e.target.value),placeholder:"https://",className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0}),f.mymapsUrl?(0,n.jsx)("span",{className:"text-xs text-red-600",children:f.mymapsUrl}):null]}),f.submit?(0,n.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:f.submit}):null,(0,n.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[(0,n.jsx)("button",{type:"button",onClick:()=>s(!1),className:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"ยกเลิก"}),(0,n.jsx)("button",{type:"button",onClick:y,disabled:p,className:"rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70",children:p?"กำลังบันทึก...":"บันทึกกำหนดการ"})]})]})})}},1707:function(e,t,s){"use strict";s.d(t,{Cq:function(){return o},DQ:function(){return l},Z6:function(){return i},Zn:function(){return r},gK:function(){return a},uA:function(){return d}});var n=s(3866);async function l(){return n.O.from("outage_jobs").select("*").order("outage_date",{ascending:!0})}async function r(e){return n.O.from("outage_jobs").select("*").eq("id",e).single()}async function o(e){var t;return n.O.from("outage_jobs").insert({outage_date:e.outage_date,equipment_code:e.equipment_code,note:null!==(t=e.note)&&void 0!==t?t:null})}async function a(e,t){var s;return n.O.from("outage_jobs").update({outage_date:t.outage_date,equipment_code:t.equipment_code,note:null!==(s=t.note)&&void 0!==s?s:null}).eq("id",e)}async function i(e,t){return n.O.from("outage_jobs").update({nakhon_status:"NOTIFIED",nakhon_notified_date:t.date,nakhon_memo_no:t.memoNo}).eq("id",e)}async function d(e){return n.O.from("outage_jobs").update({nakhon_status:"NOT_REQUIRED",nakhon_notified_date:null,nakhon_memo_no:null}).eq("id",e)}},3866:function(e,t,s){"use strict";s.d(t,{O:function(){return n}});let n=(0,s(2157).e)()},2157:function(e,t,s){"use strict";s.d(t,{X:function(){return c},e:function(){return u}});var n=s(7327);s(357);let l="https://yhkrzepnokhiqbxwhkgz.supabase.co",r="sb_publishable_CdTtNwP3k39LxhkLkKbS3w_Y3co_tFE",o=null,a=!1,i=()=>{if(!l||!r)throw Error("Missing Supabase env vars. Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY.")},d=async(e,t)=>{e&&t?await fetch("/api/auth/session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessToken:e,refreshToken:t})}):await fetch("/api/auth/session",{method:"DELETE"})},u=()=>(i(),o||(o=(0,n.eI)(l,r)),a||(a=!0,o.auth.onAuthStateChange((e,t)=>{var s,n;d(null!==(s=null==t?void 0:t.access_token)&&void 0!==s?s:null,null!==(n=null==t?void 0:t.refresh_token)&&void 0!==n?n:null)})),o),c=async e=>{await d(e.access_token,e.refresh_token)}},836:function(e,t,s){"use strict";s.d(t,{MY:function(){return o},SK:function(){return a},We:function(){return n},cS:function(){return u},cX:function(){return i},hV:function(){return d},pU:function(){return l},uI:function(){return r}});let n="min-h-screen bg-slate-50",l="rounded-2xl border border-slate-200/60 bg-white/80 shadow-sm transition hover:shadow-md",r="bg-violet-600 text-white hover:bg-violet-700 focus-visible:ring-violet-300",o="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-medium shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 ".concat(r),a="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-slate-100/60 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-violet-300 focus-visible:ring-offset-2",i="rounded-xl border border-slate-200/80 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm outline-none transition focus:border-violet-500 focus-visible:ring-2 focus-visible:ring-violet-200",d="text-sm font-medium text-violet-600 underline-offset-4 transition hover:text-violet-700 hover:underline",u=e=>{switch(e){case"RED":return"border border-rose-200/80 bg-rose-50 text-rose-700";case"YELLOW":return"border border-amber-200/80 bg-amber-50 text-amber-700";default:return"border border-emerald-200/80 bg-emerald-50 text-emerald-700"}}}},function(e){e.O(0,[200,138,971,23,744],function(){return e(e.s=8038)}),_N_E=e.O()}]);