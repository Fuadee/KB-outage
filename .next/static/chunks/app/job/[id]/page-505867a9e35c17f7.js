(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[534],{8038:function(e,t,s){Promise.resolve().then(s.bind(s,7350))},7350:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return x}});var l=s(7437),a=s(2265),r=s(6463),n=s(7138),o=s(6600),d=s(3442),i=s(9320),u=s(1707),c=s(3866);function x(){var e,t,s;let x=(0,r.useRouter)(),m=(0,r.useParams)(),[h,b]=(0,a.useState)(""),[p,f]=(0,a.useState)(""),[g,v]=(0,a.useState)(""),[j,w]=(0,a.useState)(!0),[y,N]=(0,a.useState)(!1),[_,S]=(0,a.useState)(null),[E,C]=(0,a.useState)(null),[k,O]=(0,a.useState)(!1),[D,T]=(0,a.useState)(!1),[U,q]=(0,a.useState)(!1),[L,P]=(0,a.useState)(null),[Z,H]=(0,a.useState)(null);(0,a.useEffect)(()=>{(async()=>{var e,t;if(!m.id)return;w(!0),S(null);let{data:s,error:l}=await (0,u.Zn)(m.id);if(l||!s){S(null!==(e=null==l?void 0:l.message)&&void 0!==e?e:"ไม่พบงานที่ต้องการ"),w(!1);return}C(s),b(s.outage_date),f(s.equipment_code),v(null!==(t=s.note)&&void 0!==t?t:""),w(!1)})()},[m.id]),(0,a.useEffect)(()=>{if(!Z)return;let e=window.setTimeout(()=>{H(null)},2e3);return()=>window.clearTimeout(e)},[Z]);let F=async e=>{if(e.preventDefault(),!m.id||(null==E?void 0:E.is_closed))return;if(S(null),!h||!p.trim()){S("กรุณากรอกวันที่และรหัสอุปกรณ์");return}N(!0);let{error:t}=await (0,u.gK)(m.id,{outage_date:h,equipment_code:p.trim(),note:g.trim()?g.trim():null});if(t){S(t.message),N(!1);return}N(!1),x.push("/")},I=async()=>{if(m.id&&(null==E||!E.is_closed)){N(!0),S(null);try{let t=await fetch("/api/jobs/".concat(m.id,"/delete"),{method:"DELETE"}),s=await t.json().catch(()=>null);if(!t.ok||!(null==s?void 0:s.ok)||0===s.deletedCount){var e;let t=null!==(e=null==s?void 0:s.error)&&void 0!==e?e:"ลบไม่สำเร็จ (สิทธิไม่อนุญาตหรือไม่พบรายการ)";S(t),H({message:t,tone:"error"}),N(!1);return}x.push("/")}catch(t){let e=t instanceof Error?t.message:"ลบไม่สำเร็จ (สิทธิไม่อนุญาตหรือไม่พบรายการ)";S(e),H({message:e,tone:"error"})}finally{N(!1)}}},J=e=>{C(t=>t?{...t,...e}:t)},K=async()=>{if(!E)return;q(!0),P(null);let{data:e}=await c.O.auth.getSession();if(!e.session){q(!1),T(!1),x.push("/login");return}try{let e=await fetch("/api/jobs/".concat(E.id,"/close"),{method:"POST",headers:{"Content-Type":"application/json"}});if(401===e.status){q(!1),T(!1),x.push("/login");return}let s=await e.json().catch(()=>null);if(!e.ok||!(null==s?void 0:s.ok)){var t;throw Error(null!==(t=null==s?void 0:s.error)&&void 0!==t?t:"ปิดงานไม่สำเร็จ กรุณาลองใหม่")}H({message:"✅ ปิดงานเรียบร้อย",tone:"success"}),C(e=>{var t;return e?{...e,is_closed:!0,closed_at:null!==(t=s.closed_at)&&void 0!==t?t:new Date().toISOString()}:e}),T(!1)}catch(t){let e=t instanceof Error?t.message:"ปิดงานไม่สำเร็จ กรุณาลองใหม่";P(e),H({message:e,tone:"error"})}finally{q(!1)}};if(j)return(0,l.jsx)("div",{className:"rounded-2xl border border-slate-200 bg-white px-4 py-8 text-center text-sm text-slate-500 shadow-sm",children:"กำลังโหลดข้อมูล..."});let M=null!==(e=null==E?void 0:E.is_closed)&&void 0!==e&&e,R=(null!==(t=null==E?void 0:E.notice_status)&&void 0!==t?t:"NONE")==="SCHEDULED"&&!M;return(0,l.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,l.jsxs)("header",{className:"flex flex-col gap-2",children:[(0,l.jsx)("h1",{className:"text-2xl font-semibold",children:M?"รายละเอียดงาน":"แก้ไขงาน"}),(0,l.jsx)("p",{className:"text-sm text-slate-500",children:M?"งานนี้ถูกปิดแล้วและไม่สามารถแก้ไขได้":"ปรับปรุงรายละเอียดหรือลบงานนี้ออกจากระบบ"}),Z?(0,l.jsx)("div",{className:"mt-2 rounded-xl border px-4 py-3 text-sm ".concat("success"===Z.tone?"border-emerald-200 bg-emerald-50 text-emerald-700":"border-red-200 bg-red-50 text-red-700"),children:Z.message}):null,M?(0,l.jsxs)("div",{className:"mt-2 text-sm text-slate-600",children:["ปิดเมื่อ"," ",(0,l.jsx)("span",{className:"font-medium text-slate-800",children:(null==E?void 0:E.closed_at)?new Date(E.closed_at).toLocaleString("th-TH",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-"})]}):null,(0,l.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2",children:[(null==E?void 0:E.social_status)!=="POSTED"||M?null:(0,l.jsx)("button",{type:"button",onClick:()=>O(!0),className:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:(null!==(s=E.notice_status)&&void 0!==s?s:"NONE")==="SCHEDULED"?"กำหนดการแจ้งเรียบร้อยแล้ว (แก้ไขได้)":"แจ้งหนังสือดับไฟ"}),R?(0,l.jsx)("button",{type:"button",onClick:()=>{P(null),T(!0)},className:"rounded-xl bg-amber-500 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-amber-400",children:"ปิดงาน"}):null]})]}),(0,l.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm",children:[(0,l.jsx)("h2",{className:"text-sm font-semibold text-slate-700",children:"ลิงก์แผนที่"}),(0,l.jsx)(o.Z,{googleUrl:null==E?void 0:E.map_link,myMapUrl:null==E?void 0:E.mymaps_url,className:"mt-3"})]}),(0,l.jsxs)("form",{onSubmit:F,className:"flex flex-col gap-6 rounded-2xl bg-white p-6 shadow-sm",children:[(0,l.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["วันที่ดับไฟ",(0,l.jsx)("input",{type:"date",value:h,onChange:e=>b(e.target.value),disabled:M,className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0})]}),(0,l.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["รหัสอุปกรณ์",(0,l.jsx)("input",{type:"text",value:p,onChange:e=>f(e.target.value),disabled:M,className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400",required:!0})]}),(0,l.jsxs)("label",{className:"flex flex-col gap-2 text-sm font-medium text-slate-700",children:["หมายเหตุเพิ่มเติม",(0,l.jsx)("textarea",{value:g,onChange:e=>v(e.target.value),rows:4,disabled:M,className:"rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm outline-none focus:border-slate-400"})]}),_?(0,l.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:_}):null,(0,l.jsxs)("div",{className:"flex flex-wrap gap-3",children:[M?null:(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("button",{type:"submit",disabled:y,className:"rounded-xl bg-slate-900 px-5 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70",children:y?"กำลังบันทึก...":"บันทึก"}),(0,l.jsx)("button",{type:"button",onClick:I,disabled:y,className:"rounded-xl border border-red-200 px-5 py-2 text-sm font-medium text-red-600 shadow-sm transition hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-70",children:"ลบงาน"})]}),(0,l.jsx)(n.default,{href:"/",className:"rounded-xl border border-slate-200 px-5 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"กลับ"})]})]}),(0,l.jsx)(d.Z,{job:E,open:k,onOpenChange:O,onJobUpdate:(e,t)=>J(t)}),(0,l.jsx)(i.Z,{isOpen:D,title:"ยืนยันปิดงาน?",onClose:()=>T(!1),children:(0,l.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,l.jsx)("p",{className:"text-sm text-slate-600",children:'ปิดงานแล้วจะถูกย้ายไปที่ "งานที่ปิดแล้ว" และไม่สามารถแก้ไขได้'}),L?(0,l.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:L}):null,(0,l.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[(0,l.jsx)("button",{type:"button",onClick:()=>T(!1),className:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100",children:"ยกเลิก"}),(0,l.jsx)("button",{type:"button",onClick:K,disabled:U,className:"rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70",children:U?"กำลังปิดงาน...":"ยืนยันปิดงาน"})]})]})})]})}}},function(e){e.O(0,[200,138,674,971,23,744],function(){return e(e.s=8038)}),_N_E=e.O()}]);